{"title":"浅析Spring Boot单体应用熔断技术","slug":"浅析Spring-Boot单体应用熔断技术","date":"2021-01-20T12:20:20.000Z","updated":"2021-04-19T06:44:39.305Z","comments":true,"path":"api/articles/浅析Spring-Boot单体应用熔断技术.json","excerpt":null,"covers":["https://image.eelve.com/eblog/2021012001.png","https://image.eelve.com/eblog/2021012002.png","https://image.eelve.com/eblog/2021012003.png","https://image.eelve.com/eblog/eblog-b269767ff45b4e01a1c380e38898c1c0.png"],"content":"<p>【<strong>前面的话</strong>】最近在看服务熔断的相关技术，下面就来总结一下。</p>\n<h1 id=\"壹、入围方案\"><a href=\"#壹、入围方案\" class=\"headerlink\" title=\"壹、入围方案\"></a>壹、入围方案</h1><ul>\n<li>Sentinel<ul>\n<li><a href=\"https://github.com/alibaba/Sentinel\">github地址</a></li>\n<li><a href=\"https://sentinelguard.io/zh-cn/docs/introduction.html\">https://sentinelguard.io/zh-cn/docs/introduction.html</a></li>\n<li>阿里出品，Spring Cloud Alibaba限流组件，目前持续更新中</li>\n<li>自带Dashboard，可以查看接口Qps等，并且可以动态修改各种规则</li>\n<li>流量控制，直接限流、冷启动、排队</li>\n<li>熔断降级，限制并发限制数和相应时间</li>\n<li>系统负载保护，提供系统级别防护，限制总体CPU等</li>\n<li>主要核心：资源，规则（流量控制规则、熔断降级规则、系统保护规则、来源访问控制规则 和 热点参数规则。），和指标</li>\n<li>文档非常清晰和详细，中文</li>\n<li>支持动态规则（推模式和拉模式）</li>\n</ul>\n</li>\n<li>Hystrix<ul>\n<li><a href=\"https://github.com/Netflix/Hystrix\">github地址</a></li>\n<li><a href=\"https://github.com/Netflix/Hystrix/wiki\">https://github.com/Netflix/Hystrix/wiki</a></li>\n<li>Netflix出品，Spring Cloud Netflix限流组件，已经停止新特性开发，只进行bug修复，最近更新为2018年，功能稳定</li>\n<li>有简单的dashboard页面</li>\n<li>以隔离和熔断为主的容错机制，超时或被熔断的调用将会快速失败，并可以提供 fallback 机制的初代熔断框架，异常统计基于滑动窗口</li>\n</ul>\n</li>\n<li>resilience4j<ul>\n<li><a href=\"https://github.com/resilience4j/resilience4j\">github地址</a></li>\n<li><a href=\"https://resilience4j.readme.io/docs\">https://resilience4j.readme.io/docs</a></li>\n<li>是一款轻量、简单，并且文档非常清晰、丰富的熔断工具。是Hystrix替代品，实现思路和Hystrix一致，目前持续更新中</li>\n<li>需要自己对micrometer、prometheus以及Dropwizard metrics进行整合</li>\n<li>CircuitBreaker 熔断</li>\n<li>Bulkhead 隔离</li>\n<li>RateLimiter QPS限制</li>\n<li>Retry 重试</li>\n<li>TimeLimiter 超时限制</li>\n<li>Cache 缓存</li>\n</ul>\n</li>\n<li>自己实现(基于Guava)<ul>\n<li>基于Guava的令牌桶，可以轻松实现对QPS进行限流</li>\n</ul>\n</li>\n</ul>\n<h1 id=\"贰、技术对比\"><a href=\"#贰、技术对比\" class=\"headerlink\" title=\"贰、技术对比\"></a>贰、技术对比</h1><table>\n<thead>\n<tr>\n<th></th>\n<th><strong>Sentinel</strong></th>\n<th><strong>Hystrix</strong></th>\n<th><strong>resilience4j</strong></th>\n<th>使用Guava实现</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>隔离策略</td>\n<td>信号量隔离（并发线程数限流）</td>\n<td>线程池隔离/信号量隔离</td>\n<td>信号量隔离</td>\n<td></td>\n</tr>\n<tr>\n<td>熔断降级策略</td>\n<td>基于响应时间、异常比率、异常数</td>\n<td>基于异常比率</td>\n<td>基于异常比率、响应时间</td>\n<td></td>\n</tr>\n<tr>\n<td>实时统计实现</td>\n<td>滑动窗口（LeapArray）</td>\n<td>滑动窗口（基于 RxJava）</td>\n<td>Ring Bit Buffer</td>\n<td>令牌桶</td>\n</tr>\n<tr>\n<td>动态规则配置</td>\n<td>支持多种数据源</td>\n<td>支持多种数据源</td>\n<td>有限支持</td>\n<td></td>\n</tr>\n<tr>\n<td>扩展性</td>\n<td>多个扩展点</td>\n<td>插件的形式</td>\n<td>接口的形式</td>\n<td></td>\n</tr>\n<tr>\n<td>基于注解的支持</td>\n<td>支持</td>\n<td>支持</td>\n<td>支持</td>\n<td>支持</td>\n</tr>\n<tr>\n<td>单机限流</td>\n<td>基于 QPS，支持基于调用关系的限流</td>\n<td>有限的支持</td>\n<td>Rate Limiter</td>\n<td>基于 QPS</td>\n</tr>\n<tr>\n<td>集群流控</td>\n<td>支持</td>\n<td>不支持</td>\n<td>不支持</td>\n<td></td>\n</tr>\n<tr>\n<td>流量整形</td>\n<td>支持预热模式与匀速排队控制效果</td>\n<td>不支持</td>\n<td>简单的 Rate Limiter 模式</td>\n<td></td>\n</tr>\n<tr>\n<td>系统自适应保护</td>\n<td>支持</td>\n<td>不支持</td>\n<td>不支持</td>\n<td></td>\n</tr>\n<tr>\n<td>热点识别/防护</td>\n<td>支持</td>\n<td>不支持</td>\n<td>不支持</td>\n<td></td>\n</tr>\n<tr>\n<td>Service Mesh 支持</td>\n<td>支持 Envoy/Istio</td>\n<td>不支持</td>\n<td>不支持</td>\n<td></td>\n</tr>\n<tr>\n<td>控制台</td>\n<td>提供开箱即用的控制台，可配置规则、实时监控、机器发现等</td>\n<td>简单的监控查看</td>\n<td>不提供控制台，可对接其它监控系统</td>\n<td></td>\n</tr>\n<tr>\n<td>是否支持默认规则</td>\n<td>不支持，需要针对每个接口配置规则</td>\n<td>支持</td>\n<td>支持</td>\n<td></td>\n</tr>\n<tr>\n<td>是否支持过滤异常</td>\n<td>注解单个接口支持</td>\n<td>注解和全局默认配置</td>\n<td>注解和全局默认配置</td>\n<td></td>\n</tr>\n</tbody></table>\n<h1 id=\"叁、应用改造\"><a href=\"#叁、应用改造\" class=\"headerlink\" title=\"叁、应用改造\"></a>叁、应用改造</h1><h2 id=\"3-1、sentinel\"><a href=\"#3-1、sentinel\" class=\"headerlink\" title=\"3.1、sentinel\"></a>3.1、sentinel</h2><h3 id=\"3-1-1、引入依赖\"><a href=\"#3-1-1、引入依赖\" class=\"headerlink\" title=\"3.1.1、引入依赖\"></a>3.1.1、引入依赖</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">    &lt;groupId&gt;com.alibaba.cloud&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;2.0.3.RELEASE&lt;&#x2F;version&gt;</span><br><span class=\"line\">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-1-2、改造接口或者service层\"><a href=\"#3-1-2、改造接口或者service层\" class=\"headerlink\" title=\"3.1.2、改造接口或者service层\"></a>3.1.2、改造接口或者service层</h3><blockquote>\n<p>@SentinelResource(value = “allInfos”,fallback = “errorReturn”)</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Target(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</span></span><br><span class=\"line\"><span class=\"meta\">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class=\"line\"><span class=\"meta\">@Inherited</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"meta\">@interface</span> SentinelResource &#123;</span><br><span class=\"line\">    <span class=\"comment\">//资源名称</span></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">value</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//流量方向</span></span><br><span class=\"line\">    <span class=\"function\">EntryType <span class=\"title\">entryType</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> EntryType.OUT</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//资源类型</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">resourceType</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> 0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//异常处理方法</span></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">blockHandler</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//异常处理类</span></span><br><span class=\"line\">    Class&lt;?&gt;[] blockHandlerClass() <span class=\"keyword\">default</span> &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//熔断方法</span></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">fallback</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//默认熔断方法</span></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">defaultFallback</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//熔断类</span></span><br><span class=\"line\">    Class&lt;?&gt;[] fallbackClass() <span class=\"keyword\">default</span> &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//统计异常</span></span><br><span class=\"line\">    Class&lt;? extends Throwable&gt;[] exceptionsToTrace() <span class=\"keyword\">default</span> &#123;Throwable.class&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//忽略异常</span></span><br><span class=\"line\">    Class&lt;? extends Throwable&gt;[] exceptionsToIgnore() <span class=\"keyword\">default</span> &#123;&#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@RequestMapping(&quot;/get&quot;)</span></span><br><span class=\"line\"><span class=\"meta\">@ResponseBody</span></span><br><span class=\"line\"><span class=\"meta\">@SentinelResource(value = &quot;allInfos&quot;,fallback = &quot;errorReturn&quot;)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> JsonResult <span class=\"title\">allInfos</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response, <span class=\"meta\">@RequestParam</span> Integer num)</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (num % <span class=\"number\">2</span> == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                log.info(<span class=\"string\">&quot;num % 2 == 0&quot;</span>);</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> BaseException(<span class=\"string\">&quot;something bad with 2&quot;</span>, <span class=\"number\">400</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> JsonResult.ok();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (ProgramException e) &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;error&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> JsonResult.error(<span class=\"string\">&quot;error&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-1-3、针对接口配置熔断方法或者限流方法\"><a href=\"#3-1-3、针对接口配置熔断方法或者限流方法\" class=\"headerlink\" title=\"3.1.3、针对接口配置熔断方法或者限流方法\"></a>3.1.3、针对接口配置熔断方法或者限流方法</h3><blockquote>\n<p>默认过滤拦截所有Controller接口</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 限流，参数需要和方法保持一致</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> request</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> response</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> num</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> BlockException</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> JsonResult <span class=\"title\">errorReturn</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response, <span class=\"meta\">@RequestParam</span> Integer num)</span> <span class=\"keyword\">throws</span> BlockException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JsonResult.error(<span class=\"string\">&quot;error 限流&quot;</span> + num );</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 熔断，参数需要和方法保持一直，并且需要添加BlockException异常</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> request</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> response</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> num</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> b</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> BlockException</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> JsonResult <span class=\"title\">errorReturn</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response, <span class=\"meta\">@RequestParam</span> Integer num,BlockException b)</span> <span class=\"keyword\">throws</span> BlockException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JsonResult.error(<span class=\"string\">&quot;error 熔断&quot;</span> + num );</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>注意也可以不配置限流或者熔断方法。通过全局异常去捕获<strong>UndeclaredThrowableException</strong>或者<strong>BlockException</strong>避免大量的开发量</p>\n</blockquote>\n<h3 id=\"3-1-4、接入dashboard\"><a href=\"#3-1-4、接入dashboard\" class=\"headerlink\" title=\"3.1.4、接入dashboard\"></a>3.1.4、接入dashboard</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">sentinel:</span></span><br><span class=\"line\">      <span class=\"attr\">transport:</span></span><br><span class=\"line\">        <span class=\"attr\">port:</span> <span class=\"number\">8719</span></span><br><span class=\"line\">        <span class=\"attr\">dashboard:</span> <span class=\"string\">localhost:8080</span></span><br></pre></td></tr></table></figure>\n<p><img src=\"https://image.eelve.com/eblog/2021012001.png\" alt=\"sentinel\"></p>\n<h3 id=\"3-1-5、规则持久化和动态更新\"><a href=\"#3-1-5、规则持久化和动态更新\" class=\"headerlink\" title=\"3.1.5、规则持久化和动态更新\"></a>3.1.5、规则持久化和动态更新</h3><blockquote>\n<p>接入配置中心如：zookeeper等等，并对规则采用推模式</p>\n</blockquote>\n<h2 id=\"3-2、hystrix\"><a href=\"#3-2、hystrix\" class=\"headerlink\" title=\"3.2、hystrix\"></a>3.2、hystrix</h2><h3 id=\"3-2-1、引入依赖\"><a href=\"#3-2-1、引入依赖\" class=\"headerlink\" title=\"3.2.1、引入依赖\"></a>3.2.1、引入依赖</h3> <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;spring-boot-starter-actuator&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">&lt;&#x2F;dependency&gt;</span><br><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">    &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix-dashboard&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;2.0.4.RELEASE&lt;&#x2F;version&gt;</span><br><span class=\"line\">&lt;&#x2F;dependency&gt;</span><br><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">    &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;2.0.4.RELEASE&lt;&#x2F;version&gt;</span><br><span class=\"line\">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-2-2、改造接口\"><a href=\"#3-2-2、改造接口\" class=\"headerlink\" title=\"3.2.2、改造接口\"></a>3.2.2、改造接口</h3><blockquote>\n<p>@HystrixCommand(fallbackMethod = “timeOutError”)</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Target(&#123;ElementType.METHOD&#125;)</span></span><br><span class=\"line\"><span class=\"meta\">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class=\"line\"><span class=\"meta\">@Inherited</span></span><br><span class=\"line\"><span class=\"meta\">@Documented</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"meta\">@interface</span> HystrixCommand &#123;</span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">groupKey</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">commandKey</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">threadPoolKey</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">fallbackMethod</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    HystrixProperty[] commandProperties() <span class=\"keyword\">default</span> &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    HystrixProperty[] threadPoolProperties() <span class=\"keyword\">default</span> &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    Class&lt;? extends Throwable&gt;[] ignoreExceptions() <span class=\"keyword\">default</span> &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">ObservableExecutionMode <span class=\"title\">observableExecutionMode</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> ObservableExecutionMode.EAGER</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    HystrixException[] raiseHystrixExceptions() <span class=\"keyword\">default</span> &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">defaultFallback</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@RequestMapping(&quot;/get&quot;)</span></span><br><span class=\"line\"><span class=\"meta\">@ResponseBody</span></span><br><span class=\"line\"><span class=\"meta\">@HystrixCommand(fallbackMethod = &quot;fallbackMethod&quot;)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> JsonResult <span class=\"title\">allInfos</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response, <span class=\"meta\">@RequestParam</span> Integer num)</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (num % <span class=\"number\">3</span> == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;num % 3 == 0&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> BaseException(<span class=\"string\">&quot;something bad whitch 3&quot;</span>, <span class=\"number\">400</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> JsonResult.ok();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (ProgramException | InterruptedException exception) &#123;</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;error&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JsonResult.error(<span class=\"string\">&quot;error&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-2-3、针对接口配置熔断方法\"><a href=\"#3-2-3、针对接口配置熔断方法\" class=\"headerlink\" title=\"3.2.3、针对接口配置熔断方法\"></a>3.2.3、针对接口配置熔断方法</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 该方法是熔断回调方法，参数需要和接口保持一致</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> request</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> response</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> num</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> JsonResult <span class=\"title\">fallbackMethod</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response, <span class=\"meta\">@RequestParam</span> Integer num)</span> </span>&#123;</span><br><span class=\"line\">    response.setStatus(<span class=\"number\">500</span>);</span><br><span class=\"line\">    log.info(<span class=\"string\">&quot;发生了熔断！！&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> JsonResult.error(<span class=\"string\">&quot;熔断&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-2-4、配置默认策略\"><a href=\"#3-2-4、配置默认策略\" class=\"headerlink\" title=\"3.2.4、配置默认策略\"></a>3.2.4、配置默认策略</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hystrix:</span><br><span class=\"line\">  command:</span><br><span class=\"line\">    default:</span><br><span class=\"line\">      execution:</span><br><span class=\"line\">        isolation:</span><br><span class=\"line\">          strategy: THREAD</span><br><span class=\"line\">          thread:</span><br><span class=\"line\">            # 线程超时15秒,调用Fallback方法</span><br><span class=\"line\">            timeoutInMilliseconds: 15000</span><br><span class=\"line\">      metrics:</span><br><span class=\"line\">        rollingStats:</span><br><span class=\"line\">          timeInMilliseconds: 15000</span><br><span class=\"line\">      circuitBreaker:</span><br><span class=\"line\">        # 10秒内出现3个以上请求(已临近阀值),并且出错率在50%以上,开启断路器.断开服务,调用Fallback方法</span><br><span class=\"line\">        requestVolumeThreshold: 3</span><br><span class=\"line\">        sleepWindowInMilliseconds: 10000</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-2-5、接入监控\"><a href=\"#3-2-5、接入监控\" class=\"headerlink\" title=\"3.2.5、接入监控\"></a>3.2.5、接入监控</h3><p><img src=\"https://image.eelve.com/eblog/2021012002.png\" alt=\"hystrix\"></p>\n<p><img src=\"https://image.eelve.com/eblog/2021012003.png\" alt=\"hystrix示意图\"></p>\n<blockquote>\n<p>曲线：用来记录2分钟内流量的相对变化，我们可以通过它来观察到流量的上升和下降趋势。</p>\n</blockquote>\n<blockquote>\n<p><strong>集群监控需要用到注册中心</strong></p>\n</blockquote>\n<h2 id=\"3-3、resilience4j\"><a href=\"#3-3、resilience4j\" class=\"headerlink\" title=\"3.3、resilience4j\"></a>3.3、resilience4j</h2><h3 id=\"3-3-1、引入依赖\"><a href=\"#3-3-1、引入依赖\" class=\"headerlink\" title=\"3.3.1、引入依赖\"></a>3.3.1、引入依赖</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">&lt;&#x2F;dependency&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;spring-boot-starter-test&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">    &lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class=\"line\">&lt;&#x2F;dependency&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">    &lt;groupId&gt;io.github.resilience4j&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;resilience4j-spring-boot2&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;1.6.1&lt;&#x2F;version&gt;</span><br><span class=\"line\">&lt;&#x2F;dependency&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">    &lt;groupId&gt;io.github.resilience4j&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;resilience4j-bulkhead&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;1.6.1&lt;&#x2F;version&gt;</span><br><span class=\"line\">&lt;&#x2F;dependency&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">    &lt;groupId&gt;io.github.resilience4j&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;resilience4j-ratelimiter&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;1.6.1&lt;&#x2F;version&gt;</span><br><span class=\"line\">&lt;&#x2F;dependency&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">    &lt;groupId&gt;io.github.resilience4j&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;resilience4j-timelimiter&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;1.6.1&lt;&#x2F;version&gt;</span><br><span class=\"line\">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>可以按需要引入：bulkhead，ratelimiter，timelimiter等</p>\n</blockquote>\n<h3 id=\"3-3-2、改造接口\"><a href=\"#3-3-2、改造接口\" class=\"headerlink\" title=\"3.3.2、改造接口\"></a>3.3.2、改造接口</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@RequestMapping(&quot;/get&quot;)</span></span><br><span class=\"line\"><span class=\"meta\">@ResponseBody</span></span><br><span class=\"line\"><span class=\"comment\">//@TimeLimiter(name = &quot;BulkheadA&quot;,fallbackMethod = &quot;fallbackMethod&quot;)</span></span><br><span class=\"line\"><span class=\"meta\">@CircuitBreaker(name = &quot;BulkheadA&quot;,fallbackMethod = &quot;fallbackMethod&quot;)</span></span><br><span class=\"line\"><span class=\"meta\">@Bulkhead(name = &quot;BulkheadA&quot;,fallbackMethod = &quot;fallbackMethod&quot;)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> JsonResult <span class=\"title\">allInfos</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response, <span class=\"meta\">@RequestParam</span> Integer num)</span></span>&#123;</span><br><span class=\"line\">    log.info(<span class=\"string\">&quot;param-----&gt;&quot;</span> + num);</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//Thread.sleep(num);</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (num % <span class=\"number\">2</span> == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;num % 2 == 0&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> BaseException(<span class=\"string\">&quot;something bad with 2&quot;</span>, <span class=\"number\">400</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (num % <span class=\"number\">3</span> == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;num % 3 == 0&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> BaseException(<span class=\"string\">&quot;something bad whitch 3&quot;</span>, <span class=\"number\">400</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (num % <span class=\"number\">5</span> == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;num % 5 == 0&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ProgramException(<span class=\"string\">&quot;something bad whitch 5&quot;</span>, <span class=\"number\">400</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (num % <span class=\"number\">7</span> == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;num % 7 == 0&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">int</span> res = <span class=\"number\">1</span> / <span class=\"number\">0</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JsonResult.ok();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (BufferUnderflowException e) &#123;</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;error&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JsonResult.error(<span class=\"string\">&quot;error&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-3-3、针对接口配置熔断方法\"><a href=\"#3-3-3、针对接口配置熔断方法\" class=\"headerlink\" title=\"3.3.3、针对接口配置熔断方法\"></a>3.3.3、针对接口配置熔断方法</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 需要参数一致，并且加上相应异常</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> request</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> response</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> num</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> exception</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> JsonResult <span class=\"title\">fallbackMethod</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response, <span class=\"meta\">@RequestParam</span> Integer num, BulkheadFullException exception)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> JsonResult.error(<span class=\"string\">&quot;error 熔断&quot;</span> + num );</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-3-4、配置规则\"><a href=\"#3-3-4、配置规则\" class=\"headerlink\" title=\"3.3.4、配置规则\"></a>3.3.4、配置规则</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">resilience4j.circuitbreaker:</span></span><br><span class=\"line\">    <span class=\"attr\">instances:</span></span><br><span class=\"line\">        <span class=\"attr\">backendA:</span></span><br><span class=\"line\">            <span class=\"attr\">registerHealthIndicator:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">            <span class=\"attr\">slidingWindowSize:</span> <span class=\"number\">100</span></span><br><span class=\"line\">        <span class=\"attr\">backendB:</span></span><br><span class=\"line\">            <span class=\"attr\">registerHealthIndicator:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">            <span class=\"attr\">slidingWindowSize:</span> <span class=\"number\">10</span></span><br><span class=\"line\">            <span class=\"attr\">permittedNumberOfCallsInHalfOpenState:</span> <span class=\"number\">3</span></span><br><span class=\"line\">            <span class=\"attr\">slidingWindowType:</span> <span class=\"string\">TIME_BASED</span></span><br><span class=\"line\">            <span class=\"attr\">minimumNumberOfCalls:</span> <span class=\"number\">20</span></span><br><span class=\"line\">            <span class=\"attr\">waitDurationInOpenState:</span> <span class=\"string\">50s</span></span><br><span class=\"line\">            <span class=\"attr\">failureRateThreshold:</span> <span class=\"number\">50</span></span><br><span class=\"line\">            <span class=\"attr\">eventConsumerBufferSize:</span> <span class=\"number\">10</span></span><br><span class=\"line\">            <span class=\"attr\">recordFailurePredicate:</span> <span class=\"string\">io.github.robwin.exception.RecordFailurePredicate</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">resilience4j.retry:</span></span><br><span class=\"line\">    <span class=\"attr\">instances:</span></span><br><span class=\"line\">        <span class=\"attr\">backendA:</span></span><br><span class=\"line\">            <span class=\"attr\">maxRetryAttempts:</span> <span class=\"number\">3</span></span><br><span class=\"line\">            <span class=\"attr\">waitDuration:</span> <span class=\"string\">10s</span></span><br><span class=\"line\">            <span class=\"attr\">enableExponentialBackoff:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">            <span class=\"attr\">exponentialBackoffMultiplier:</span> <span class=\"number\">2</span></span><br><span class=\"line\">            <span class=\"attr\">retryExceptions:</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">org.springframework.web.client.HttpServerErrorException</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">java.io.IOException</span></span><br><span class=\"line\">            <span class=\"attr\">ignoreExceptions:</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">io.github.robwin.exception.BusinessException</span></span><br><span class=\"line\">        <span class=\"attr\">backendB:</span></span><br><span class=\"line\">            <span class=\"attr\">maxRetryAttempts:</span> <span class=\"number\">3</span></span><br><span class=\"line\">            <span class=\"attr\">waitDuration:</span> <span class=\"string\">10s</span></span><br><span class=\"line\">            <span class=\"attr\">retryExceptions:</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">org.springframework.web.client.HttpServerErrorException</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">java.io.IOException</span></span><br><span class=\"line\">            <span class=\"attr\">ignoreExceptions:</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">io.github.robwin.exception.BusinessException</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">resilience4j.bulkhead:</span></span><br><span class=\"line\">    <span class=\"attr\">instances:</span></span><br><span class=\"line\">        <span class=\"attr\">backendA:</span></span><br><span class=\"line\">            <span class=\"attr\">maxConcurrentCalls:</span> <span class=\"number\">10</span></span><br><span class=\"line\">        <span class=\"attr\">backendB:</span></span><br><span class=\"line\">            <span class=\"attr\">maxWaitDuration:</span> <span class=\"string\">10ms</span></span><br><span class=\"line\">            <span class=\"attr\">maxConcurrentCalls:</span> <span class=\"number\">20</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">resilience4j.thread-pool-bulkhead:</span></span><br><span class=\"line\">  <span class=\"attr\">instances:</span></span><br><span class=\"line\">    <span class=\"attr\">backendC:</span></span><br><span class=\"line\">      <span class=\"attr\">maxThreadPoolSize:</span> <span class=\"number\">1</span></span><br><span class=\"line\">      <span class=\"attr\">coreThreadPoolSize:</span> <span class=\"number\">1</span></span><br><span class=\"line\">      <span class=\"attr\">queueCapacity:</span> <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">resilience4j.ratelimiter:</span></span><br><span class=\"line\">    <span class=\"attr\">instances:</span></span><br><span class=\"line\">        <span class=\"attr\">backendA:</span></span><br><span class=\"line\">            <span class=\"attr\">limitForPeriod:</span> <span class=\"number\">10</span></span><br><span class=\"line\">            <span class=\"attr\">limitRefreshPeriod:</span> <span class=\"string\">1s</span></span><br><span class=\"line\">            <span class=\"attr\">timeoutDuration:</span> <span class=\"number\">0</span></span><br><span class=\"line\">            <span class=\"attr\">registerHealthIndicator:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">            <span class=\"attr\">eventConsumerBufferSize:</span> <span class=\"number\">100</span></span><br><span class=\"line\">        <span class=\"attr\">backendB:</span></span><br><span class=\"line\">            <span class=\"attr\">limitForPeriod:</span> <span class=\"number\">6</span></span><br><span class=\"line\">            <span class=\"attr\">limitRefreshPeriod:</span> <span class=\"string\">500ms</span></span><br><span class=\"line\">            <span class=\"attr\">timeoutDuration:</span> <span class=\"string\">3s</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">resilience4j.timelimiter:</span></span><br><span class=\"line\">    <span class=\"attr\">instances:</span></span><br><span class=\"line\">        <span class=\"attr\">backendA:</span></span><br><span class=\"line\">            <span class=\"attr\">timeoutDuration:</span> <span class=\"string\">2s</span></span><br><span class=\"line\">            <span class=\"attr\">cancelRunningFuture:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">        <span class=\"attr\">backendB:</span></span><br><span class=\"line\">            <span class=\"attr\">timeoutDuration:</span> <span class=\"string\">1s</span></span><br><span class=\"line\">            <span class=\"attr\">cancelRunningFuture:</span> <span class=\"literal\">false</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>配置的规则可以被代码覆盖</p>\n</blockquote>\n<h3 id=\"3-3-5、配置监控\"><a href=\"#3-3-5、配置监控\" class=\"headerlink\" title=\"3.3.5、配置监控\"></a>3.3.5、配置监控</h3><blockquote>\n<p>如grafana等</p>\n</blockquote>\n<h1 id=\"肆、关注点\"><a href=\"#肆、关注点\" class=\"headerlink\" title=\"肆、关注点\"></a>肆、关注点</h1><ul>\n<li>是否需要过滤部分异常</li>\n<li>是否需要全局默认规则</li>\n<li>可能需要引入其他中间件</li>\n<li>k8s流量控制</li>\n<li>规则存储和动态修改</li>\n<li>接入改造代价</li>\n</ul>\n<h1 id=\"【后面的话】\"><a href=\"#【后面的话】\" class=\"headerlink\" title=\"【后面的话】\"></a>【<strong>后面的话</strong>】</h1><p>个人建议的话，比较推荐sentinel，它提供了很多接口便于开发者自己拓展，同时我觉得他的规则动态更新也比较方便。最后是相关示例代码:<a href=\"https://github.com/eelve/limiting\">单体应用示例代码</a></p>\n<hr>\n<p><img src=\"https://image.eelve.com/eblog/eblog-b269767ff45b4e01a1c380e38898c1c0.png\" alt=\"薏米笔记\"></p>\n","more":"<p>【<strong>前面的话</strong>】最近在看服务熔断的相关技术，下面就来总结一下。</p>\n<h1 id=\"壹、入围方案\"><a href=\"#壹、入围方案\" class=\"headerlink\" title=\"壹、入围方案\"></a>壹、入围方案</h1><ul>\n<li>Sentinel<ul>\n<li><a href=\"https://github.com/alibaba/Sentinel\">github地址</a></li>\n<li><a href=\"https://sentinelguard.io/zh-cn/docs/introduction.html\">https://sentinelguard.io/zh-cn/docs/introduction.html</a></li>\n<li>阿里出品，Spring Cloud Alibaba限流组件，目前持续更新中</li>\n<li>自带Dashboard，可以查看接口Qps等，并且可以动态修改各种规则</li>\n<li>流量控制，直接限流、冷启动、排队</li>\n<li>熔断降级，限制并发限制数和相应时间</li>\n<li>系统负载保护，提供系统级别防护，限制总体CPU等</li>\n<li>主要核心：资源，规则（流量控制规则、熔断降级规则、系统保护规则、来源访问控制规则 和 热点参数规则。），和指标</li>\n<li>文档非常清晰和详细，中文</li>\n<li>支持动态规则（推模式和拉模式）</li>\n</ul>\n</li>\n<li>Hystrix<ul>\n<li><a href=\"https://github.com/Netflix/Hystrix\">github地址</a></li>\n<li><a href=\"https://github.com/Netflix/Hystrix/wiki\">https://github.com/Netflix/Hystrix/wiki</a></li>\n<li>Netflix出品，Spring Cloud Netflix限流组件，已经停止新特性开发，只进行bug修复，最近更新为2018年，功能稳定</li>\n<li>有简单的dashboard页面</li>\n<li>以隔离和熔断为主的容错机制，超时或被熔断的调用将会快速失败，并可以提供 fallback 机制的初代熔断框架，异常统计基于滑动窗口</li>\n</ul>\n</li>\n<li>resilience4j<ul>\n<li><a href=\"https://github.com/resilience4j/resilience4j\">github地址</a></li>\n<li><a href=\"https://resilience4j.readme.io/docs\">https://resilience4j.readme.io/docs</a></li>\n<li>是一款轻量、简单，并且文档非常清晰、丰富的熔断工具。是Hystrix替代品，实现思路和Hystrix一致，目前持续更新中</li>\n<li>需要自己对micrometer、prometheus以及Dropwizard metrics进行整合</li>\n<li>CircuitBreaker 熔断</li>\n<li>Bulkhead 隔离</li>\n<li>RateLimiter QPS限制</li>\n<li>Retry 重试</li>\n<li>TimeLimiter 超时限制</li>\n<li>Cache 缓存</li>\n</ul>\n</li>\n<li>自己实现(基于Guava)<ul>\n<li>基于Guava的令牌桶，可以轻松实现对QPS进行限流</li>\n</ul>\n</li>\n</ul>\n<h1 id=\"贰、技术对比\"><a href=\"#贰、技术对比\" class=\"headerlink\" title=\"贰、技术对比\"></a>贰、技术对比</h1><table>\n<thead>\n<tr>\n<th></th>\n<th><strong>Sentinel</strong></th>\n<th><strong>Hystrix</strong></th>\n<th><strong>resilience4j</strong></th>\n<th>使用Guava实现</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>隔离策略</td>\n<td>信号量隔离（并发线程数限流）</td>\n<td>线程池隔离/信号量隔离</td>\n<td>信号量隔离</td>\n<td></td>\n</tr>\n<tr>\n<td>熔断降级策略</td>\n<td>基于响应时间、异常比率、异常数</td>\n<td>基于异常比率</td>\n<td>基于异常比率、响应时间</td>\n<td></td>\n</tr>\n<tr>\n<td>实时统计实现</td>\n<td>滑动窗口（LeapArray）</td>\n<td>滑动窗口（基于 RxJava）</td>\n<td>Ring Bit Buffer</td>\n<td>令牌桶</td>\n</tr>\n<tr>\n<td>动态规则配置</td>\n<td>支持多种数据源</td>\n<td>支持多种数据源</td>\n<td>有限支持</td>\n<td></td>\n</tr>\n<tr>\n<td>扩展性</td>\n<td>多个扩展点</td>\n<td>插件的形式</td>\n<td>接口的形式</td>\n<td></td>\n</tr>\n<tr>\n<td>基于注解的支持</td>\n<td>支持</td>\n<td>支持</td>\n<td>支持</td>\n<td>支持</td>\n</tr>\n<tr>\n<td>单机限流</td>\n<td>基于 QPS，支持基于调用关系的限流</td>\n<td>有限的支持</td>\n<td>Rate Limiter</td>\n<td>基于 QPS</td>\n</tr>\n<tr>\n<td>集群流控</td>\n<td>支持</td>\n<td>不支持</td>\n<td>不支持</td>\n<td></td>\n</tr>\n<tr>\n<td>流量整形</td>\n<td>支持预热模式与匀速排队控制效果</td>\n<td>不支持</td>\n<td>简单的 Rate Limiter 模式</td>\n<td></td>\n</tr>\n<tr>\n<td>系统自适应保护</td>\n<td>支持</td>\n<td>不支持</td>\n<td>不支持</td>\n<td></td>\n</tr>\n<tr>\n<td>热点识别/防护</td>\n<td>支持</td>\n<td>不支持</td>\n<td>不支持</td>\n<td></td>\n</tr>\n<tr>\n<td>Service Mesh 支持</td>\n<td>支持 Envoy/Istio</td>\n<td>不支持</td>\n<td>不支持</td>\n<td></td>\n</tr>\n<tr>\n<td>控制台</td>\n<td>提供开箱即用的控制台，可配置规则、实时监控、机器发现等</td>\n<td>简单的监控查看</td>\n<td>不提供控制台，可对接其它监控系统</td>\n<td></td>\n</tr>\n<tr>\n<td>是否支持默认规则</td>\n<td>不支持，需要针对每个接口配置规则</td>\n<td>支持</td>\n<td>支持</td>\n<td></td>\n</tr>\n<tr>\n<td>是否支持过滤异常</td>\n<td>注解单个接口支持</td>\n<td>注解和全局默认配置</td>\n<td>注解和全局默认配置</td>\n<td></td>\n</tr>\n</tbody></table>\n<h1 id=\"叁、应用改造\"><a href=\"#叁、应用改造\" class=\"headerlink\" title=\"叁、应用改造\"></a>叁、应用改造</h1><h2 id=\"3-1、sentinel\"><a href=\"#3-1、sentinel\" class=\"headerlink\" title=\"3.1、sentinel\"></a>3.1、sentinel</h2><h3 id=\"3-1-1、引入依赖\"><a href=\"#3-1-1、引入依赖\" class=\"headerlink\" title=\"3.1.1、引入依赖\"></a>3.1.1、引入依赖</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">    &lt;groupId&gt;com.alibaba.cloud&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;2.0.3.RELEASE&lt;&#x2F;version&gt;</span><br><span class=\"line\">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-1-2、改造接口或者service层\"><a href=\"#3-1-2、改造接口或者service层\" class=\"headerlink\" title=\"3.1.2、改造接口或者service层\"></a>3.1.2、改造接口或者service层</h3><blockquote>\n<p>@SentinelResource(value = “allInfos”,fallback = “errorReturn”)</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Target(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</span></span><br><span class=\"line\"><span class=\"meta\">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class=\"line\"><span class=\"meta\">@Inherited</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"meta\">@interface</span> SentinelResource &#123;</span><br><span class=\"line\">    <span class=\"comment\">//资源名称</span></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">value</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//流量方向</span></span><br><span class=\"line\">    <span class=\"function\">EntryType <span class=\"title\">entryType</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> EntryType.OUT</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//资源类型</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">resourceType</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> 0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//异常处理方法</span></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">blockHandler</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//异常处理类</span></span><br><span class=\"line\">    Class&lt;?&gt;[] blockHandlerClass() <span class=\"keyword\">default</span> &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//熔断方法</span></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">fallback</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//默认熔断方法</span></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">defaultFallback</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//熔断类</span></span><br><span class=\"line\">    Class&lt;?&gt;[] fallbackClass() <span class=\"keyword\">default</span> &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//统计异常</span></span><br><span class=\"line\">    Class&lt;? extends Throwable&gt;[] exceptionsToTrace() <span class=\"keyword\">default</span> &#123;Throwable.class&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//忽略异常</span></span><br><span class=\"line\">    Class&lt;? extends Throwable&gt;[] exceptionsToIgnore() <span class=\"keyword\">default</span> &#123;&#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@RequestMapping(&quot;/get&quot;)</span></span><br><span class=\"line\"><span class=\"meta\">@ResponseBody</span></span><br><span class=\"line\"><span class=\"meta\">@SentinelResource(value = &quot;allInfos&quot;,fallback = &quot;errorReturn&quot;)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> JsonResult <span class=\"title\">allInfos</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response, <span class=\"meta\">@RequestParam</span> Integer num)</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (num % <span class=\"number\">2</span> == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                log.info(<span class=\"string\">&quot;num % 2 == 0&quot;</span>);</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> BaseException(<span class=\"string\">&quot;something bad with 2&quot;</span>, <span class=\"number\">400</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> JsonResult.ok();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (ProgramException e) &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;error&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> JsonResult.error(<span class=\"string\">&quot;error&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-1-3、针对接口配置熔断方法或者限流方法\"><a href=\"#3-1-3、针对接口配置熔断方法或者限流方法\" class=\"headerlink\" title=\"3.1.3、针对接口配置熔断方法或者限流方法\"></a>3.1.3、针对接口配置熔断方法或者限流方法</h3><blockquote>\n<p>默认过滤拦截所有Controller接口</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 限流，参数需要和方法保持一致</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> request</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> response</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> num</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> BlockException</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> JsonResult <span class=\"title\">errorReturn</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response, <span class=\"meta\">@RequestParam</span> Integer num)</span> <span class=\"keyword\">throws</span> BlockException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JsonResult.error(<span class=\"string\">&quot;error 限流&quot;</span> + num );</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 熔断，参数需要和方法保持一直，并且需要添加BlockException异常</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> request</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> response</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> num</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> b</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> BlockException</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> JsonResult <span class=\"title\">errorReturn</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response, <span class=\"meta\">@RequestParam</span> Integer num,BlockException b)</span> <span class=\"keyword\">throws</span> BlockException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JsonResult.error(<span class=\"string\">&quot;error 熔断&quot;</span> + num );</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>注意也可以不配置限流或者熔断方法。通过全局异常去捕获<strong>UndeclaredThrowableException</strong>或者<strong>BlockException</strong>避免大量的开发量</p>\n</blockquote>\n<h3 id=\"3-1-4、接入dashboard\"><a href=\"#3-1-4、接入dashboard\" class=\"headerlink\" title=\"3.1.4、接入dashboard\"></a>3.1.4、接入dashboard</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">sentinel:</span></span><br><span class=\"line\">      <span class=\"attr\">transport:</span></span><br><span class=\"line\">        <span class=\"attr\">port:</span> <span class=\"number\">8719</span></span><br><span class=\"line\">        <span class=\"attr\">dashboard:</span> <span class=\"string\">localhost:8080</span></span><br></pre></td></tr></table></figure>\n<p><img src=\"https://image.eelve.com/eblog/2021012001.png\" alt=\"sentinel\"></p>\n<h3 id=\"3-1-5、规则持久化和动态更新\"><a href=\"#3-1-5、规则持久化和动态更新\" class=\"headerlink\" title=\"3.1.5、规则持久化和动态更新\"></a>3.1.5、规则持久化和动态更新</h3><blockquote>\n<p>接入配置中心如：zookeeper等等，并对规则采用推模式</p>\n</blockquote>\n<h2 id=\"3-2、hystrix\"><a href=\"#3-2、hystrix\" class=\"headerlink\" title=\"3.2、hystrix\"></a>3.2、hystrix</h2><h3 id=\"3-2-1、引入依赖\"><a href=\"#3-2-1、引入依赖\" class=\"headerlink\" title=\"3.2.1、引入依赖\"></a>3.2.1、引入依赖</h3> <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;spring-boot-starter-actuator&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">&lt;&#x2F;dependency&gt;</span><br><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">    &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix-dashboard&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;2.0.4.RELEASE&lt;&#x2F;version&gt;</span><br><span class=\"line\">&lt;&#x2F;dependency&gt;</span><br><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">    &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;2.0.4.RELEASE&lt;&#x2F;version&gt;</span><br><span class=\"line\">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-2-2、改造接口\"><a href=\"#3-2-2、改造接口\" class=\"headerlink\" title=\"3.2.2、改造接口\"></a>3.2.2、改造接口</h3><blockquote>\n<p>@HystrixCommand(fallbackMethod = “timeOutError”)</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Target(&#123;ElementType.METHOD&#125;)</span></span><br><span class=\"line\"><span class=\"meta\">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class=\"line\"><span class=\"meta\">@Inherited</span></span><br><span class=\"line\"><span class=\"meta\">@Documented</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"meta\">@interface</span> HystrixCommand &#123;</span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">groupKey</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">commandKey</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">threadPoolKey</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">fallbackMethod</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    HystrixProperty[] commandProperties() <span class=\"keyword\">default</span> &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    HystrixProperty[] threadPoolProperties() <span class=\"keyword\">default</span> &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    Class&lt;? extends Throwable&gt;[] ignoreExceptions() <span class=\"keyword\">default</span> &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">ObservableExecutionMode <span class=\"title\">observableExecutionMode</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> ObservableExecutionMode.EAGER</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    HystrixException[] raiseHystrixExceptions() <span class=\"keyword\">default</span> &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">defaultFallback</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@RequestMapping(&quot;/get&quot;)</span></span><br><span class=\"line\"><span class=\"meta\">@ResponseBody</span></span><br><span class=\"line\"><span class=\"meta\">@HystrixCommand(fallbackMethod = &quot;fallbackMethod&quot;)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> JsonResult <span class=\"title\">allInfos</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response, <span class=\"meta\">@RequestParam</span> Integer num)</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (num % <span class=\"number\">3</span> == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;num % 3 == 0&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> BaseException(<span class=\"string\">&quot;something bad whitch 3&quot;</span>, <span class=\"number\">400</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> JsonResult.ok();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (ProgramException | InterruptedException exception) &#123;</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;error&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JsonResult.error(<span class=\"string\">&quot;error&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-2-3、针对接口配置熔断方法\"><a href=\"#3-2-3、针对接口配置熔断方法\" class=\"headerlink\" title=\"3.2.3、针对接口配置熔断方法\"></a>3.2.3、针对接口配置熔断方法</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 该方法是熔断回调方法，参数需要和接口保持一致</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> request</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> response</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> num</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> JsonResult <span class=\"title\">fallbackMethod</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response, <span class=\"meta\">@RequestParam</span> Integer num)</span> </span>&#123;</span><br><span class=\"line\">    response.setStatus(<span class=\"number\">500</span>);</span><br><span class=\"line\">    log.info(<span class=\"string\">&quot;发生了熔断！！&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> JsonResult.error(<span class=\"string\">&quot;熔断&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-2-4、配置默认策略\"><a href=\"#3-2-4、配置默认策略\" class=\"headerlink\" title=\"3.2.4、配置默认策略\"></a>3.2.4、配置默认策略</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hystrix:</span><br><span class=\"line\">  command:</span><br><span class=\"line\">    default:</span><br><span class=\"line\">      execution:</span><br><span class=\"line\">        isolation:</span><br><span class=\"line\">          strategy: THREAD</span><br><span class=\"line\">          thread:</span><br><span class=\"line\">            # 线程超时15秒,调用Fallback方法</span><br><span class=\"line\">            timeoutInMilliseconds: 15000</span><br><span class=\"line\">      metrics:</span><br><span class=\"line\">        rollingStats:</span><br><span class=\"line\">          timeInMilliseconds: 15000</span><br><span class=\"line\">      circuitBreaker:</span><br><span class=\"line\">        # 10秒内出现3个以上请求(已临近阀值),并且出错率在50%以上,开启断路器.断开服务,调用Fallback方法</span><br><span class=\"line\">        requestVolumeThreshold: 3</span><br><span class=\"line\">        sleepWindowInMilliseconds: 10000</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-2-5、接入监控\"><a href=\"#3-2-5、接入监控\" class=\"headerlink\" title=\"3.2.5、接入监控\"></a>3.2.5、接入监控</h3><p><img src=\"https://image.eelve.com/eblog/2021012002.png\" alt=\"hystrix\"></p>\n<p><img src=\"https://image.eelve.com/eblog/2021012003.png\" alt=\"hystrix示意图\"></p>\n<blockquote>\n<p>曲线：用来记录2分钟内流量的相对变化，我们可以通过它来观察到流量的上升和下降趋势。</p>\n</blockquote>\n<blockquote>\n<p><strong>集群监控需要用到注册中心</strong></p>\n</blockquote>\n<h2 id=\"3-3、resilience4j\"><a href=\"#3-3、resilience4j\" class=\"headerlink\" title=\"3.3、resilience4j\"></a>3.3、resilience4j</h2><h3 id=\"3-3-1、引入依赖\"><a href=\"#3-3-1、引入依赖\" class=\"headerlink\" title=\"3.3.1、引入依赖\"></a>3.3.1、引入依赖</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">&lt;&#x2F;dependency&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;spring-boot-starter-test&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">    &lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class=\"line\">&lt;&#x2F;dependency&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">    &lt;groupId&gt;io.github.resilience4j&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;resilience4j-spring-boot2&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;1.6.1&lt;&#x2F;version&gt;</span><br><span class=\"line\">&lt;&#x2F;dependency&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">    &lt;groupId&gt;io.github.resilience4j&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;resilience4j-bulkhead&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;1.6.1&lt;&#x2F;version&gt;</span><br><span class=\"line\">&lt;&#x2F;dependency&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">    &lt;groupId&gt;io.github.resilience4j&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;resilience4j-ratelimiter&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;1.6.1&lt;&#x2F;version&gt;</span><br><span class=\"line\">&lt;&#x2F;dependency&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">    &lt;groupId&gt;io.github.resilience4j&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;resilience4j-timelimiter&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;1.6.1&lt;&#x2F;version&gt;</span><br><span class=\"line\">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>可以按需要引入：bulkhead，ratelimiter，timelimiter等</p>\n</blockquote>\n<h3 id=\"3-3-2、改造接口\"><a href=\"#3-3-2、改造接口\" class=\"headerlink\" title=\"3.3.2、改造接口\"></a>3.3.2、改造接口</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@RequestMapping(&quot;/get&quot;)</span></span><br><span class=\"line\"><span class=\"meta\">@ResponseBody</span></span><br><span class=\"line\"><span class=\"comment\">//@TimeLimiter(name = &quot;BulkheadA&quot;,fallbackMethod = &quot;fallbackMethod&quot;)</span></span><br><span class=\"line\"><span class=\"meta\">@CircuitBreaker(name = &quot;BulkheadA&quot;,fallbackMethod = &quot;fallbackMethod&quot;)</span></span><br><span class=\"line\"><span class=\"meta\">@Bulkhead(name = &quot;BulkheadA&quot;,fallbackMethod = &quot;fallbackMethod&quot;)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> JsonResult <span class=\"title\">allInfos</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response, <span class=\"meta\">@RequestParam</span> Integer num)</span></span>&#123;</span><br><span class=\"line\">    log.info(<span class=\"string\">&quot;param-----&gt;&quot;</span> + num);</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//Thread.sleep(num);</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (num % <span class=\"number\">2</span> == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;num % 2 == 0&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> BaseException(<span class=\"string\">&quot;something bad with 2&quot;</span>, <span class=\"number\">400</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (num % <span class=\"number\">3</span> == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;num % 3 == 0&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> BaseException(<span class=\"string\">&quot;something bad whitch 3&quot;</span>, <span class=\"number\">400</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (num % <span class=\"number\">5</span> == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;num % 5 == 0&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ProgramException(<span class=\"string\">&quot;something bad whitch 5&quot;</span>, <span class=\"number\">400</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (num % <span class=\"number\">7</span> == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;num % 7 == 0&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">int</span> res = <span class=\"number\">1</span> / <span class=\"number\">0</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JsonResult.ok();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (BufferUnderflowException e) &#123;</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;error&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JsonResult.error(<span class=\"string\">&quot;error&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-3-3、针对接口配置熔断方法\"><a href=\"#3-3-3、针对接口配置熔断方法\" class=\"headerlink\" title=\"3.3.3、针对接口配置熔断方法\"></a>3.3.3、针对接口配置熔断方法</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 需要参数一致，并且加上相应异常</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> request</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> response</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> num</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> exception</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> JsonResult <span class=\"title\">fallbackMethod</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response, <span class=\"meta\">@RequestParam</span> Integer num, BulkheadFullException exception)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> JsonResult.error(<span class=\"string\">&quot;error 熔断&quot;</span> + num );</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-3-4、配置规则\"><a href=\"#3-3-4、配置规则\" class=\"headerlink\" title=\"3.3.4、配置规则\"></a>3.3.4、配置规则</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">resilience4j.circuitbreaker:</span></span><br><span class=\"line\">    <span class=\"attr\">instances:</span></span><br><span class=\"line\">        <span class=\"attr\">backendA:</span></span><br><span class=\"line\">            <span class=\"attr\">registerHealthIndicator:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">            <span class=\"attr\">slidingWindowSize:</span> <span class=\"number\">100</span></span><br><span class=\"line\">        <span class=\"attr\">backendB:</span></span><br><span class=\"line\">            <span class=\"attr\">registerHealthIndicator:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">            <span class=\"attr\">slidingWindowSize:</span> <span class=\"number\">10</span></span><br><span class=\"line\">            <span class=\"attr\">permittedNumberOfCallsInHalfOpenState:</span> <span class=\"number\">3</span></span><br><span class=\"line\">            <span class=\"attr\">slidingWindowType:</span> <span class=\"string\">TIME_BASED</span></span><br><span class=\"line\">            <span class=\"attr\">minimumNumberOfCalls:</span> <span class=\"number\">20</span></span><br><span class=\"line\">            <span class=\"attr\">waitDurationInOpenState:</span> <span class=\"string\">50s</span></span><br><span class=\"line\">            <span class=\"attr\">failureRateThreshold:</span> <span class=\"number\">50</span></span><br><span class=\"line\">            <span class=\"attr\">eventConsumerBufferSize:</span> <span class=\"number\">10</span></span><br><span class=\"line\">            <span class=\"attr\">recordFailurePredicate:</span> <span class=\"string\">io.github.robwin.exception.RecordFailurePredicate</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">resilience4j.retry:</span></span><br><span class=\"line\">    <span class=\"attr\">instances:</span></span><br><span class=\"line\">        <span class=\"attr\">backendA:</span></span><br><span class=\"line\">            <span class=\"attr\">maxRetryAttempts:</span> <span class=\"number\">3</span></span><br><span class=\"line\">            <span class=\"attr\">waitDuration:</span> <span class=\"string\">10s</span></span><br><span class=\"line\">            <span class=\"attr\">enableExponentialBackoff:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">            <span class=\"attr\">exponentialBackoffMultiplier:</span> <span class=\"number\">2</span></span><br><span class=\"line\">            <span class=\"attr\">retryExceptions:</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">org.springframework.web.client.HttpServerErrorException</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">java.io.IOException</span></span><br><span class=\"line\">            <span class=\"attr\">ignoreExceptions:</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">io.github.robwin.exception.BusinessException</span></span><br><span class=\"line\">        <span class=\"attr\">backendB:</span></span><br><span class=\"line\">            <span class=\"attr\">maxRetryAttempts:</span> <span class=\"number\">3</span></span><br><span class=\"line\">            <span class=\"attr\">waitDuration:</span> <span class=\"string\">10s</span></span><br><span class=\"line\">            <span class=\"attr\">retryExceptions:</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">org.springframework.web.client.HttpServerErrorException</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">java.io.IOException</span></span><br><span class=\"line\">            <span class=\"attr\">ignoreExceptions:</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">io.github.robwin.exception.BusinessException</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">resilience4j.bulkhead:</span></span><br><span class=\"line\">    <span class=\"attr\">instances:</span></span><br><span class=\"line\">        <span class=\"attr\">backendA:</span></span><br><span class=\"line\">            <span class=\"attr\">maxConcurrentCalls:</span> <span class=\"number\">10</span></span><br><span class=\"line\">        <span class=\"attr\">backendB:</span></span><br><span class=\"line\">            <span class=\"attr\">maxWaitDuration:</span> <span class=\"string\">10ms</span></span><br><span class=\"line\">            <span class=\"attr\">maxConcurrentCalls:</span> <span class=\"number\">20</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">resilience4j.thread-pool-bulkhead:</span></span><br><span class=\"line\">  <span class=\"attr\">instances:</span></span><br><span class=\"line\">    <span class=\"attr\">backendC:</span></span><br><span class=\"line\">      <span class=\"attr\">maxThreadPoolSize:</span> <span class=\"number\">1</span></span><br><span class=\"line\">      <span class=\"attr\">coreThreadPoolSize:</span> <span class=\"number\">1</span></span><br><span class=\"line\">      <span class=\"attr\">queueCapacity:</span> <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">resilience4j.ratelimiter:</span></span><br><span class=\"line\">    <span class=\"attr\">instances:</span></span><br><span class=\"line\">        <span class=\"attr\">backendA:</span></span><br><span class=\"line\">            <span class=\"attr\">limitForPeriod:</span> <span class=\"number\">10</span></span><br><span class=\"line\">            <span class=\"attr\">limitRefreshPeriod:</span> <span class=\"string\">1s</span></span><br><span class=\"line\">            <span class=\"attr\">timeoutDuration:</span> <span class=\"number\">0</span></span><br><span class=\"line\">            <span class=\"attr\">registerHealthIndicator:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">            <span class=\"attr\">eventConsumerBufferSize:</span> <span class=\"number\">100</span></span><br><span class=\"line\">        <span class=\"attr\">backendB:</span></span><br><span class=\"line\">            <span class=\"attr\">limitForPeriod:</span> <span class=\"number\">6</span></span><br><span class=\"line\">            <span class=\"attr\">limitRefreshPeriod:</span> <span class=\"string\">500ms</span></span><br><span class=\"line\">            <span class=\"attr\">timeoutDuration:</span> <span class=\"string\">3s</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">resilience4j.timelimiter:</span></span><br><span class=\"line\">    <span class=\"attr\">instances:</span></span><br><span class=\"line\">        <span class=\"attr\">backendA:</span></span><br><span class=\"line\">            <span class=\"attr\">timeoutDuration:</span> <span class=\"string\">2s</span></span><br><span class=\"line\">            <span class=\"attr\">cancelRunningFuture:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">        <span class=\"attr\">backendB:</span></span><br><span class=\"line\">            <span class=\"attr\">timeoutDuration:</span> <span class=\"string\">1s</span></span><br><span class=\"line\">            <span class=\"attr\">cancelRunningFuture:</span> <span class=\"literal\">false</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>配置的规则可以被代码覆盖</p>\n</blockquote>\n<h3 id=\"3-3-5、配置监控\"><a href=\"#3-3-5、配置监控\" class=\"headerlink\" title=\"3.3.5、配置监控\"></a>3.3.5、配置监控</h3><blockquote>\n<p>如grafana等</p>\n</blockquote>\n<h1 id=\"肆、关注点\"><a href=\"#肆、关注点\" class=\"headerlink\" title=\"肆、关注点\"></a>肆、关注点</h1><ul>\n<li>是否需要过滤部分异常</li>\n<li>是否需要全局默认规则</li>\n<li>可能需要引入其他中间件</li>\n<li>k8s流量控制</li>\n<li>规则存储和动态修改</li>\n<li>接入改造代价</li>\n</ul>\n<h1 id=\"【后面的话】\"><a href=\"#【后面的话】\" class=\"headerlink\" title=\"【后面的话】\"></a>【<strong>后面的话</strong>】</h1><p>个人建议的话，比较推荐sentinel，它提供了很多接口便于开发者自己拓展，同时我觉得他的规则动态更新也比较方便。最后是相关示例代码:<a href=\"https://github.com/eelve/limiting\">单体应用示例代码</a></p>\n<hr>\n<p><img src=\"https://image.eelve.com/eblog/eblog-b269767ff45b4e01a1c380e38898c1c0.png\" alt=\"薏米笔记\"></p>\n","categories":[{"name":"springboot","path":"api/categories/springboot.json"}],"tags":[{"name":"java","path":"api/tags/java.json"},{"name":"springboot","path":"api/tags/springboot.json"}]}