{"title":"Elastic Stack实战之应用日志监控","slug":"Elastic-Stack实战之应用日志监控","date":"2020-03-14T13:49:22.000Z","updated":"2023-09-30T08:39:39.667Z","comments":true,"path":"api/articles/Elastic-Stack实战之应用日志监控.json","excerpt":null,"covers":["https://image.eelve.com/eblog/2020031400-c4c762ac3d134548bea4fb19e64088a6.png","https://image.eelve.com/eblog/2020031401-66d588f9d78f4bf4b34b3d9d0f82001d.png","https://image.eelve.com/eblog/2020031402-28114b868ca3470497782f558737d25e.png","https://image.eelve.com/eblog/eblog-b269767ff45b4e01a1c380e38898c1c0.png"],"content":"<p>【<strong>前面的话</strong>】在前面我们已经介绍了<a href=\"https://eelve.com/posts/975621af.html\">Elasticsearch</a>、<a href=\"https://eelve.com/posts/e05eadb0.html\">Logstash</a>、<a href=\"https://eelve.com/posts/b84d7094.html\">Kibana</a>和<a href=\"https://eelve.com/posts/d1a5ff40.html\">Beats</a>，并且都对各个组件进行了初步体验。今天我们就来模拟一把日常使用，来收集一个我们自己的应用的日志，并使用Kibana展示。</p>\n<hr>\n<h1 id=\"壹、软件版本\"><a href=\"#壹、软件版本\" class=\"headerlink\" title=\"壹、软件版本\"></a>壹、软件版本</h1><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">Centos：CentOS-7-x86_64-Minimal-1908</span></span><br><span class=\"line\"><span class=\"attr\">VM:</span> <span class=\"number\">15.5</span><span class=\"number\">.0</span> <span class=\"string\">build-14665864</span></span><br><span class=\"line\"><span class=\"attr\">Java:</span> <span class=\"number\">1.8</span><span class=\"string\">.0_211</span></span><br><span class=\"line\"><span class=\"attr\">Elasticsearch:</span> <span class=\"string\">elasticsearch-7.6.0</span></span><br><span class=\"line\"><span class=\"attr\">Logstash:</span> <span class=\"string\">logstash-7.6.0</span></span><br><span class=\"line\"><span class=\"attr\">Kibana:</span> <span class=\"string\">kibana-7.6.0</span></span><br><span class=\"line\"><span class=\"string\">Filebeat：filebeat-7.6.0</span></span><br></pre></td></tr></table></figure>\n<h1 id=\"贰、自定义采集应用\"><a href=\"#贰、自定义采集应用\" class=\"headerlink\" title=\"贰、自定义采集应用\"></a>贰、自定义采集应用</h1><p>我们这里来模拟一个现在购物网站的使用，主要代码如下</p>\n<ul>\n<li>核心代码</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.eelve.elk.dashboardgenerate;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.commons.lang3.RandomUtils;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.joda.time.DateTime;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.slf4j.Logger;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.slf4j.LoggerFactory;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@SpringBootApplication</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DashboardGenerateApplication</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Logger LOGGER = LoggerFactory.getLogger(DashboardGenerateApplication.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String[] VISIT = <span class=\"keyword\">new</span> String[]&#123;<span class=\"string\">&quot;浏览页面&quot;</span>, <span class=\"string\">&quot;评论商品&quot;</span>, <span class=\"string\">&quot;加入收藏&quot;</span>, <span class=\"string\">&quot;加入购物车&quot;</span>, <span class=\"string\">&quot;提交订单&quot;</span>, <span class=\"string\">&quot;使用优惠券&quot;</span>, <span class=\"string\">&quot;领取优惠券&quot;</span>, <span class=\"string\">&quot;搜索&quot;</span>, <span class=\"string\">&quot;查看订单&quot;</span>&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">while</span>(<span class=\"keyword\">true</span>)&#123;</span><br><span class=\"line\">            Long sleep = RandomUtils.nextLong(<span class=\"number\">200</span>, <span class=\"number\">1000</span> * <span class=\"number\">5</span>);</span><br><span class=\"line\">            Thread.sleep(sleep);</span><br><span class=\"line\">            Long maxUserId = <span class=\"number\">9999L</span>;</span><br><span class=\"line\">            Long userId = RandomUtils.nextLong(<span class=\"number\">1</span>, maxUserId);</span><br><span class=\"line\">            String visit = VISIT[RandomUtils.nextInt(<span class=\"number\">0</span>, VISIT.length)];</span><br><span class=\"line\">            DateTime now = <span class=\"keyword\">new</span> DateTime();</span><br><span class=\"line\">            <span class=\"keyword\">int</span> maxHour = now.getHourOfDay();</span><br><span class=\"line\">            <span class=\"keyword\">int</span> maxMillis = now.getMinuteOfHour();</span><br><span class=\"line\">            <span class=\"keyword\">int</span> maxSeconds = now.getSecondOfMinute();</span><br><span class=\"line\">            String date = now.plusHours(-(RandomUtils.nextInt(<span class=\"number\">0</span>, maxHour)))</span><br><span class=\"line\">                    .plusMinutes(-(RandomUtils.nextInt(<span class=\"number\">0</span>, maxMillis)))</span><br><span class=\"line\">                    .plusSeconds(-(RandomUtils.nextInt(<span class=\"number\">0</span>, maxSeconds)))</span><br><span class=\"line\">                    .toString(<span class=\"string\">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            String result = <span class=\"string\">&quot;IIO|&quot;</span> + userId + <span class=\"string\">&quot;|&quot;</span> + visit + <span class=\"string\">&quot;|&quot;</span> + date;</span><br><span class=\"line\">            LOGGER.info(result);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>日志配置文件</li>\n</ul>\n<figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">log4j.rootLogger</span>=<span class=\"string\">DEBUG,A1,A2</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">log4j.appender.A1</span>=<span class=\"string\">org.apache.log4j.ConsoleAppender</span></span><br><span class=\"line\"><span class=\"meta\">log4j.appender.A1.layout</span>=<span class=\"string\">org.apache.log4j.PatternLayout</span></span><br><span class=\"line\"><span class=\"meta\">log4j.appender.A1.layout.ConversionPattern</span>=<span class=\"string\">[%p] %-d&#123;yyyy-MM-dd HH:mm:ss&#125; [%c] - %m%n</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">log4j.appender.A2</span> = <span class=\"string\">org.apache.log4j.DailyRollingFileAppender</span></span><br><span class=\"line\"><span class=\"meta\">log4j.appender.A2.File</span> = <span class=\"string\">/iio/logs/app.log</span></span><br><span class=\"line\"><span class=\"meta\">log4j.appender.A2.Append</span> = <span class=\"string\">true</span></span><br><span class=\"line\"><span class=\"meta\">log4j.appender.A2.Threshold</span> = <span class=\"string\">INFO</span></span><br><span class=\"line\"><span class=\"meta\">log4j.appender.A2.layout</span> = <span class=\"string\">org.apache.log4j.PatternLayout</span></span><br><span class=\"line\"><span class=\"meta\">log4j.appender.A2.layout.ConversionPattern</span> =<span class=\"string\">[%p] %-d&#123;yyyy-MM-dd HH:mm:ss&#125; [%c] - %m%n</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul>\n<li>运行结果</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;C:\\Program Files\\Java\\jdk1.8.0_221\\bin\\java.exe&quot; -XX:TieredStopAtLevel=1 -noverify -Dspring.output.ansi.enabled=always -Dcom.sun.management.jmxremote -Dspring.jmx.enabled=true -Dspring.liveBeansView.mbeanDomain -Dspring.application.admin.enabled=true &quot;-javaagent:C:\\Program Files\\JetBrains\\IntelliJ IDEA 2019.1\\lib\\idea_rt.jar=6396:C:\\Program Files\\JetBrains\\IntelliJ IDEA 2019.1\\bin&quot; -Dfile.encoding=UTF-8 -classpath &quot;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\charsets.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\deploy.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\ext\\access-bridge-64.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\ext\\cldrdata.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\ext\\dnsns.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\ext\\jaccess.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\ext\\jfxrt.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\ext\\localedata.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\ext\\nashorn.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\ext\\sunec.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\ext\\sunjce_provider.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\ext\\sunmscapi.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\ext\\sunpkcs11.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\ext\\zipfs.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\javaws.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\jce.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\jfr.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\jfxswt.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\jsse.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\management-agent.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\plugin.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\resources.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\rt.jar;D:\\iio\\dashboard-generate\\target\\classes;C:\\Users\\Chirius\\.m2\\repository\\org\\springframework\\boot\\spring-boot-starter\\2.2.5.RELEASE\\spring-boot-starter-2.2.5.RELEASE.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\springframework\\boot\\spring-boot\\2.2.5.RELEASE\\spring-boot-2.2.5.RELEASE.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\springframework\\spring-context\\5.2.4.RELEASE\\spring-context-5.2.4.RELEASE.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\springframework\\spring-aop\\5.2.4.RELEASE\\spring-aop-5.2.4.RELEASE.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\springframework\\spring-beans\\5.2.4.RELEASE\\spring-beans-5.2.4.RELEASE.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\springframework\\spring-expression\\5.2.4.RELEASE\\spring-expression-5.2.4.RELEASE.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\springframework\\boot\\spring-boot-autoconfigure\\2.2.5.RELEASE\\spring-boot-autoconfigure-2.2.5.RELEASE.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\springframework\\boot\\spring-boot-starter-logging\\2.2.5.RELEASE\\spring-boot-starter-logging-2.2.5.RELEASE.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\apache\\logging\\log4j\\log4j-to-slf4j\\2.12.1\\log4j-to-slf4j-2.12.1.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\apache\\logging\\log4j\\log4j-api\\2.12.1\\log4j-api-2.12.1.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\slf4j\\jul-to-slf4j\\1.7.30\\jul-to-slf4j-1.7.30.jar;C:\\Users\\Chirius\\.m2\\repository\\jakarta\\annotation\\jakarta.annotation-api\\1.3.5\\jakarta.annotation-api-1.3.5.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\springframework\\spring-core\\5.2.4.RELEASE\\spring-core-5.2.4.RELEASE.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\springframework\\spring-jcl\\5.2.4.RELEASE\\spring-jcl-5.2.4.RELEASE.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\yaml\\snakeyaml\\1.25\\snakeyaml-1.25.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\apache\\commons\\commons-lang3\\3.3.2\\commons-lang3-3.3.2.jar;C:\\Users\\Chirius\\.m2\\repository\\joda-time\\joda-time\\2.9.9\\joda-time-2.9.9.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\slf4j\\slf4j-log4j12\\1.7.26\\slf4j-log4j12-1.7.26.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\slf4j\\slf4j-api\\1.7.30\\slf4j-api-1.7.30.jar;C:\\Users\\Chirius\\.m2\\repository\\log4j\\log4j\\1.2.17\\log4j-1.2.17.jar&quot; com.eelve.elk.dashboardgenerate.DashboardGenerateApplication</span><br><span class=\"line\">[INFO] 2020-03-14 21:06:09 [com.eelve.elk.dashboardgenerate.DashboardGenerateApplication] - IIO|4234|加入收藏|2020-03-14 04:04:03</span><br><span class=\"line\">[INFO] 2020-03-14 21:06:11 [com.eelve.elk.dashboardgenerate.DashboardGenerateApplication] - IIO|6502|领取优惠券|2020-03-14 14:05:07</span><br><span class=\"line\">[INFO] 2020-03-14 21:06:12 [com.eelve.elk.dashboardgenerate.DashboardGenerateApplication] - IIO|3694|加入购物车|2020-03-14 20:03:09</span><br><span class=\"line\">[INFO] 2020-03-14 21:06:14 [com.eelve.elk.dashboardgenerate.DashboardGenerateApplication] - IIO|8112|使用优惠券|2020-03-14 12:06:02</span><br><span class=\"line\">[INFO] 2020-03-14 21:06:14 [com.eelve.elk.dashboardgenerate.DashboardGenerateApplication] - IIO|3391|加入收藏|2020-03-14 02:01:05</span><br><span class=\"line\">[INFO] 2020-03-14 21:06:17 [com.eelve.elk.dashboardgenerate.DashboardGenerateApplication] - IIO|3696|搜索|2020-03-14 04:06:05</span><br><span class=\"line\">[INFO] 2020-03-14 21:06:18 [com.eelve.elk.dashboardgenerate.DashboardGenerateApplication] - IIO|6670|使用优惠券|2020-03-14 17:04:17</span><br><span class=\"line\">[INFO] 2020-03-14 21:06:21 [com.eelve.elk.dashboardgenerate.DashboardGenerateApplication] - IIO|6646|搜索|2020-03-14 11:06:05</span><br><span class=\"line\">[INFO] 2020-03-14 21:06:24 [com.eelve.elk.dashboardgenerate.DashboardGenerateApplication] - IIO|8227|使用优惠券|2020-03-14 12:06:24</span><br><span class=\"line\"></span><br><span class=\"line\">Process finished with exit code -1</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>我们这里模拟了用户的操作，并记录到/iio/logs/app.log文件中。主要的业务流程为：APP-&gt;filebeat-&gt;logstash-&gt;elasticsearch-&gt;kibanan-&gt;User</p>\n<p><img src=\"https://image.eelve.com/eblog/2020031400-c4c762ac3d134548bea4fb19e64088a6.png\" alt=\"2020031400\"></p>\n<h1 id=\"叁、准备过程\"><a href=\"#叁、准备过程\" class=\"headerlink\" title=\"叁、准备过程\"></a>叁、准备过程</h1><h2 id=\"3-1-编写filebeat配置\"><a href=\"#3-1-编写filebeat配置\" class=\"headerlink\" title=\"3.1 编写filebeat配置\"></a>3.1 编写filebeat配置</h2><figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[iio@192 filebeat]$ vi dashboard.yml </span><br><span class=\"line\">filebeat.inputs:</span><br><span class=\"line\">- type: log</span><br><span class=\"line\">  enabled: true</span><br><span class=\"line\">  paths:</span><br><span class=\"line\">    - /iio/logs/*.log</span><br><span class=\"line\">output.logstash:</span><br><span class=\"line\">  hosts: [&quot;192.168.237.11:5044&quot;]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"3-2-编写logstash配置\"><a href=\"#3-2-编写logstash配置\" class=\"headerlink\" title=\"3.2 编写logstash配置\"></a>3.2 编写logstash配置</h2><figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[iio@192 config]$ vi logstash-dashboard.yml </span><br><span class=\"line\">input &#123;</span><br><span class=\"line\">  beats &#123;</span><br><span class=\"line\">    port =&gt; &quot;5044&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">filter &#123;</span><br><span class=\"line\">  mutate &#123;</span><br><span class=\"line\">    split =&gt; &#123;&quot;message&quot;=&gt;&quot;|&quot;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  mutate &#123;</span><br><span class=\"line\">    add_field =&gt; &#123;</span><br><span class=\"line\">       &quot;userId&quot; =&gt; &quot;%&#123;[message][1]&#125;&quot;</span><br><span class=\"line\">       &quot;visit&quot; =&gt; &quot;%&#123;[message][2]&#125;&quot;</span><br><span class=\"line\">       &quot;date&quot; =&gt; &quot;%&#123;[message][3]&#125;&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  mutate &#123;</span><br><span class=\"line\">    convert =&gt; &#123;</span><br><span class=\"line\">        &quot;userId&quot; =&gt; &quot;integer&quot;</span><br><span class=\"line\">        &quot;visit&quot; =&gt; &quot;string&quot;</span><br><span class=\"line\">        &quot;date&quot; =&gt; &quot;string&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">output &#123;</span><br><span class=\"line\">    elasticsearch &#123;</span><br><span class=\"line\">        hosts =&gt; [&quot;192.168.237.11:9200&quot;]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"3-3-启动应用\"><a href=\"#3-3-启动应用\" class=\"headerlink\" title=\"3.3 启动应用\"></a>3.3 启动应用</h2><figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@192 home]# java -jar dashboard-generate-0.0.1-SNAPSHOT.jar &amp;</span><br></pre></td></tr></table></figure>\n<h2 id=\"3-4-启动elasticsearch\"><a href=\"#3-4-启动elasticsearch\" class=\"headerlink\" title=\"3.4 启动elasticsearch\"></a>3.4 启动elasticsearch</h2><figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[iio@192 bin]$ ./elasticsearch</span><br></pre></td></tr></table></figure>\n<h2 id=\"3-5-启动kibana\"><a href=\"#3-5-启动kibana\" class=\"headerlink\" title=\"3.5 启动kibana\"></a>3.5 启动kibana</h2><figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[iio@192 bin]$ ./kibana</span><br></pre></td></tr></table></figure>\n<h2 id=\"3-6-启动logstash\"><a href=\"#3-6-启动logstash\" class=\"headerlink\" title=\"3.6 启动logstash\"></a>3.6 启动logstash</h2><figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[iio@192 bin]$ ./logstash -f /usr/elastic/logstash/config/logstash-dashboard.yml</span><br></pre></td></tr></table></figure>\n<h2 id=\"3-7-启动filebeat\"><a href=\"#3-7-启动filebeat\" class=\"headerlink\" title=\"3.7 启动filebeat\"></a>3.7 启动filebeat</h2><figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[iio@192 filebeat]$ ./filebeat  -e -c dashboard.yml</span><br></pre></td></tr></table></figure>\n<h2 id=\"3-8-查看采集的数据\"><a href=\"#3-8-查看采集的数据\" class=\"headerlink\" title=\"3.8 查看采集的数据\"></a>3.8 查看采集的数据</h2><p><img src=\"https://image.eelve.com/eblog/2020031401-66d588f9d78f4bf4b34b3d9d0f82001d.png\" alt=\"2020031401\"></p>\n<h2 id=\"3-9-开始制作大屏\"><a href=\"#3-9-开始制作大屏\" class=\"headerlink\" title=\"3.9 开始制作大屏\"></a>3.9 开始制作大屏</h2><p><img src=\"https://image.eelve.com/eblog/2020031402-28114b868ca3470497782f558737d25e.png\" alt=\"2020031402\"><br><img src=\"https://image.eelve.com/eblog/2020031403-7b2ffa7f424b478781543ffb2b1b4207.png\" alt=\"2020031403\"><br><img src=\"https://image.eelve.com/eblog/2020031404-41d668eff3e247e7aa942d850e7775fa.png\" alt=\"2020031404\"><br><img src=\"https://image.eelve.com/eblog/2020031405-2aba46902b5f4495bfae81991385b60d.png\" alt=\"2020031405\"><br><img src=\"https://image.eelve.com/eblog/2020031406-8dbfc5fc883e46298da14ceb8e14348c.png\" alt=\"2020031406\"><br><img src=\"https://image.eelve.com/eblog/2020031407-cd57f9cb79b64ca6acaa2ba604e78511.png\" alt=\"2020031407\"></p>\n<p>到这里我们可以看到就已经完成了对我们自定义数据的监控，然后还利用了Kibana做了图表化展示。</p>\n<hr>\n<p>【<strong>后面的话</strong>】在我们日常应用中，我们的日志需要按照某种规则产生，方便我们使用logstash进行过滤，然后做一些处理。也就是说我们在开发之前就应该想好日志生成的格式，然后设计好日志的处理方式。</p>\n<hr>\n<p><img src=\"https://image.eelve.com/eblog/eblog-b269767ff45b4e01a1c380e38898c1c0.png\" alt=\"薏米笔记\"></p>\n","more":"<p>【<strong>前面的话</strong>】在前面我们已经介绍了<a href=\"https://eelve.com/posts/975621af.html\">Elasticsearch</a>、<a href=\"https://eelve.com/posts/e05eadb0.html\">Logstash</a>、<a href=\"https://eelve.com/posts/b84d7094.html\">Kibana</a>和<a href=\"https://eelve.com/posts/d1a5ff40.html\">Beats</a>，并且都对各个组件进行了初步体验。今天我们就来模拟一把日常使用，来收集一个我们自己的应用的日志，并使用Kibana展示。</p>\n<hr>\n<h1 id=\"壹、软件版本\"><a href=\"#壹、软件版本\" class=\"headerlink\" title=\"壹、软件版本\"></a>壹、软件版本</h1><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">Centos：CentOS-7-x86_64-Minimal-1908</span></span><br><span class=\"line\"><span class=\"attr\">VM:</span> <span class=\"number\">15.5</span><span class=\"number\">.0</span> <span class=\"string\">build-14665864</span></span><br><span class=\"line\"><span class=\"attr\">Java:</span> <span class=\"number\">1.8</span><span class=\"string\">.0_211</span></span><br><span class=\"line\"><span class=\"attr\">Elasticsearch:</span> <span class=\"string\">elasticsearch-7.6.0</span></span><br><span class=\"line\"><span class=\"attr\">Logstash:</span> <span class=\"string\">logstash-7.6.0</span></span><br><span class=\"line\"><span class=\"attr\">Kibana:</span> <span class=\"string\">kibana-7.6.0</span></span><br><span class=\"line\"><span class=\"string\">Filebeat：filebeat-7.6.0</span></span><br></pre></td></tr></table></figure>\n<h1 id=\"贰、自定义采集应用\"><a href=\"#贰、自定义采集应用\" class=\"headerlink\" title=\"贰、自定义采集应用\"></a>贰、自定义采集应用</h1><p>我们这里来模拟一个现在购物网站的使用，主要代码如下</p>\n<ul>\n<li>核心代码</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.eelve.elk.dashboardgenerate;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.commons.lang3.RandomUtils;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.joda.time.DateTime;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.slf4j.Logger;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.slf4j.LoggerFactory;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@SpringBootApplication</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DashboardGenerateApplication</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Logger LOGGER = LoggerFactory.getLogger(DashboardGenerateApplication.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String[] VISIT = <span class=\"keyword\">new</span> String[]&#123;<span class=\"string\">&quot;浏览页面&quot;</span>, <span class=\"string\">&quot;评论商品&quot;</span>, <span class=\"string\">&quot;加入收藏&quot;</span>, <span class=\"string\">&quot;加入购物车&quot;</span>, <span class=\"string\">&quot;提交订单&quot;</span>, <span class=\"string\">&quot;使用优惠券&quot;</span>, <span class=\"string\">&quot;领取优惠券&quot;</span>, <span class=\"string\">&quot;搜索&quot;</span>, <span class=\"string\">&quot;查看订单&quot;</span>&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">while</span>(<span class=\"keyword\">true</span>)&#123;</span><br><span class=\"line\">            Long sleep = RandomUtils.nextLong(<span class=\"number\">200</span>, <span class=\"number\">1000</span> * <span class=\"number\">5</span>);</span><br><span class=\"line\">            Thread.sleep(sleep);</span><br><span class=\"line\">            Long maxUserId = <span class=\"number\">9999L</span>;</span><br><span class=\"line\">            Long userId = RandomUtils.nextLong(<span class=\"number\">1</span>, maxUserId);</span><br><span class=\"line\">            String visit = VISIT[RandomUtils.nextInt(<span class=\"number\">0</span>, VISIT.length)];</span><br><span class=\"line\">            DateTime now = <span class=\"keyword\">new</span> DateTime();</span><br><span class=\"line\">            <span class=\"keyword\">int</span> maxHour = now.getHourOfDay();</span><br><span class=\"line\">            <span class=\"keyword\">int</span> maxMillis = now.getMinuteOfHour();</span><br><span class=\"line\">            <span class=\"keyword\">int</span> maxSeconds = now.getSecondOfMinute();</span><br><span class=\"line\">            String date = now.plusHours(-(RandomUtils.nextInt(<span class=\"number\">0</span>, maxHour)))</span><br><span class=\"line\">                    .plusMinutes(-(RandomUtils.nextInt(<span class=\"number\">0</span>, maxMillis)))</span><br><span class=\"line\">                    .plusSeconds(-(RandomUtils.nextInt(<span class=\"number\">0</span>, maxSeconds)))</span><br><span class=\"line\">                    .toString(<span class=\"string\">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            String result = <span class=\"string\">&quot;IIO|&quot;</span> + userId + <span class=\"string\">&quot;|&quot;</span> + visit + <span class=\"string\">&quot;|&quot;</span> + date;</span><br><span class=\"line\">            LOGGER.info(result);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>日志配置文件</li>\n</ul>\n<figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">log4j.rootLogger</span>=<span class=\"string\">DEBUG,A1,A2</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">log4j.appender.A1</span>=<span class=\"string\">org.apache.log4j.ConsoleAppender</span></span><br><span class=\"line\"><span class=\"meta\">log4j.appender.A1.layout</span>=<span class=\"string\">org.apache.log4j.PatternLayout</span></span><br><span class=\"line\"><span class=\"meta\">log4j.appender.A1.layout.ConversionPattern</span>=<span class=\"string\">[%p] %-d&#123;yyyy-MM-dd HH:mm:ss&#125; [%c] - %m%n</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">log4j.appender.A2</span> = <span class=\"string\">org.apache.log4j.DailyRollingFileAppender</span></span><br><span class=\"line\"><span class=\"meta\">log4j.appender.A2.File</span> = <span class=\"string\">/iio/logs/app.log</span></span><br><span class=\"line\"><span class=\"meta\">log4j.appender.A2.Append</span> = <span class=\"string\">true</span></span><br><span class=\"line\"><span class=\"meta\">log4j.appender.A2.Threshold</span> = <span class=\"string\">INFO</span></span><br><span class=\"line\"><span class=\"meta\">log4j.appender.A2.layout</span> = <span class=\"string\">org.apache.log4j.PatternLayout</span></span><br><span class=\"line\"><span class=\"meta\">log4j.appender.A2.layout.ConversionPattern</span> =<span class=\"string\">[%p] %-d&#123;yyyy-MM-dd HH:mm:ss&#125; [%c] - %m%n</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul>\n<li>运行结果</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;C:\\Program Files\\Java\\jdk1.8.0_221\\bin\\java.exe&quot; -XX:TieredStopAtLevel=1 -noverify -Dspring.output.ansi.enabled=always -Dcom.sun.management.jmxremote -Dspring.jmx.enabled=true -Dspring.liveBeansView.mbeanDomain -Dspring.application.admin.enabled=true &quot;-javaagent:C:\\Program Files\\JetBrains\\IntelliJ IDEA 2019.1\\lib\\idea_rt.jar=6396:C:\\Program Files\\JetBrains\\IntelliJ IDEA 2019.1\\bin&quot; -Dfile.encoding=UTF-8 -classpath &quot;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\charsets.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\deploy.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\ext\\access-bridge-64.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\ext\\cldrdata.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\ext\\dnsns.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\ext\\jaccess.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\ext\\jfxrt.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\ext\\localedata.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\ext\\nashorn.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\ext\\sunec.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\ext\\sunjce_provider.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\ext\\sunmscapi.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\ext\\sunpkcs11.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\ext\\zipfs.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\javaws.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\jce.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\jfr.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\jfxswt.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\jsse.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\management-agent.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\plugin.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\resources.jar;C:\\Program Files\\Java\\jdk1.8.0_221\\jre\\lib\\rt.jar;D:\\iio\\dashboard-generate\\target\\classes;C:\\Users\\Chirius\\.m2\\repository\\org\\springframework\\boot\\spring-boot-starter\\2.2.5.RELEASE\\spring-boot-starter-2.2.5.RELEASE.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\springframework\\boot\\spring-boot\\2.2.5.RELEASE\\spring-boot-2.2.5.RELEASE.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\springframework\\spring-context\\5.2.4.RELEASE\\spring-context-5.2.4.RELEASE.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\springframework\\spring-aop\\5.2.4.RELEASE\\spring-aop-5.2.4.RELEASE.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\springframework\\spring-beans\\5.2.4.RELEASE\\spring-beans-5.2.4.RELEASE.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\springframework\\spring-expression\\5.2.4.RELEASE\\spring-expression-5.2.4.RELEASE.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\springframework\\boot\\spring-boot-autoconfigure\\2.2.5.RELEASE\\spring-boot-autoconfigure-2.2.5.RELEASE.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\springframework\\boot\\spring-boot-starter-logging\\2.2.5.RELEASE\\spring-boot-starter-logging-2.2.5.RELEASE.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\apache\\logging\\log4j\\log4j-to-slf4j\\2.12.1\\log4j-to-slf4j-2.12.1.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\apache\\logging\\log4j\\log4j-api\\2.12.1\\log4j-api-2.12.1.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\slf4j\\jul-to-slf4j\\1.7.30\\jul-to-slf4j-1.7.30.jar;C:\\Users\\Chirius\\.m2\\repository\\jakarta\\annotation\\jakarta.annotation-api\\1.3.5\\jakarta.annotation-api-1.3.5.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\springframework\\spring-core\\5.2.4.RELEASE\\spring-core-5.2.4.RELEASE.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\springframework\\spring-jcl\\5.2.4.RELEASE\\spring-jcl-5.2.4.RELEASE.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\yaml\\snakeyaml\\1.25\\snakeyaml-1.25.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\apache\\commons\\commons-lang3\\3.3.2\\commons-lang3-3.3.2.jar;C:\\Users\\Chirius\\.m2\\repository\\joda-time\\joda-time\\2.9.9\\joda-time-2.9.9.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\slf4j\\slf4j-log4j12\\1.7.26\\slf4j-log4j12-1.7.26.jar;C:\\Users\\Chirius\\.m2\\repository\\org\\slf4j\\slf4j-api\\1.7.30\\slf4j-api-1.7.30.jar;C:\\Users\\Chirius\\.m2\\repository\\log4j\\log4j\\1.2.17\\log4j-1.2.17.jar&quot; com.eelve.elk.dashboardgenerate.DashboardGenerateApplication</span><br><span class=\"line\">[INFO] 2020-03-14 21:06:09 [com.eelve.elk.dashboardgenerate.DashboardGenerateApplication] - IIO|4234|加入收藏|2020-03-14 04:04:03</span><br><span class=\"line\">[INFO] 2020-03-14 21:06:11 [com.eelve.elk.dashboardgenerate.DashboardGenerateApplication] - IIO|6502|领取优惠券|2020-03-14 14:05:07</span><br><span class=\"line\">[INFO] 2020-03-14 21:06:12 [com.eelve.elk.dashboardgenerate.DashboardGenerateApplication] - IIO|3694|加入购物车|2020-03-14 20:03:09</span><br><span class=\"line\">[INFO] 2020-03-14 21:06:14 [com.eelve.elk.dashboardgenerate.DashboardGenerateApplication] - IIO|8112|使用优惠券|2020-03-14 12:06:02</span><br><span class=\"line\">[INFO] 2020-03-14 21:06:14 [com.eelve.elk.dashboardgenerate.DashboardGenerateApplication] - IIO|3391|加入收藏|2020-03-14 02:01:05</span><br><span class=\"line\">[INFO] 2020-03-14 21:06:17 [com.eelve.elk.dashboardgenerate.DashboardGenerateApplication] - IIO|3696|搜索|2020-03-14 04:06:05</span><br><span class=\"line\">[INFO] 2020-03-14 21:06:18 [com.eelve.elk.dashboardgenerate.DashboardGenerateApplication] - IIO|6670|使用优惠券|2020-03-14 17:04:17</span><br><span class=\"line\">[INFO] 2020-03-14 21:06:21 [com.eelve.elk.dashboardgenerate.DashboardGenerateApplication] - IIO|6646|搜索|2020-03-14 11:06:05</span><br><span class=\"line\">[INFO] 2020-03-14 21:06:24 [com.eelve.elk.dashboardgenerate.DashboardGenerateApplication] - IIO|8227|使用优惠券|2020-03-14 12:06:24</span><br><span class=\"line\"></span><br><span class=\"line\">Process finished with exit code -1</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>我们这里模拟了用户的操作，并记录到/iio/logs/app.log文件中。主要的业务流程为：APP-&gt;filebeat-&gt;logstash-&gt;elasticsearch-&gt;kibanan-&gt;User</p>\n<p><img src=\"https://image.eelve.com/eblog/2020031400-c4c762ac3d134548bea4fb19e64088a6.png\" alt=\"2020031400\"></p>\n<h1 id=\"叁、准备过程\"><a href=\"#叁、准备过程\" class=\"headerlink\" title=\"叁、准备过程\"></a>叁、准备过程</h1><h2 id=\"3-1-编写filebeat配置\"><a href=\"#3-1-编写filebeat配置\" class=\"headerlink\" title=\"3.1 编写filebeat配置\"></a>3.1 编写filebeat配置</h2><figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[iio@192 filebeat]$ vi dashboard.yml </span><br><span class=\"line\">filebeat.inputs:</span><br><span class=\"line\">- type: log</span><br><span class=\"line\">  enabled: true</span><br><span class=\"line\">  paths:</span><br><span class=\"line\">    - /iio/logs/*.log</span><br><span class=\"line\">output.logstash:</span><br><span class=\"line\">  hosts: [&quot;192.168.237.11:5044&quot;]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"3-2-编写logstash配置\"><a href=\"#3-2-编写logstash配置\" class=\"headerlink\" title=\"3.2 编写logstash配置\"></a>3.2 编写logstash配置</h2><figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[iio@192 config]$ vi logstash-dashboard.yml </span><br><span class=\"line\">input &#123;</span><br><span class=\"line\">  beats &#123;</span><br><span class=\"line\">    port =&gt; &quot;5044&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">filter &#123;</span><br><span class=\"line\">  mutate &#123;</span><br><span class=\"line\">    split =&gt; &#123;&quot;message&quot;=&gt;&quot;|&quot;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  mutate &#123;</span><br><span class=\"line\">    add_field =&gt; &#123;</span><br><span class=\"line\">       &quot;userId&quot; =&gt; &quot;%&#123;[message][1]&#125;&quot;</span><br><span class=\"line\">       &quot;visit&quot; =&gt; &quot;%&#123;[message][2]&#125;&quot;</span><br><span class=\"line\">       &quot;date&quot; =&gt; &quot;%&#123;[message][3]&#125;&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  mutate &#123;</span><br><span class=\"line\">    convert =&gt; &#123;</span><br><span class=\"line\">        &quot;userId&quot; =&gt; &quot;integer&quot;</span><br><span class=\"line\">        &quot;visit&quot; =&gt; &quot;string&quot;</span><br><span class=\"line\">        &quot;date&quot; =&gt; &quot;string&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">output &#123;</span><br><span class=\"line\">    elasticsearch &#123;</span><br><span class=\"line\">        hosts =&gt; [&quot;192.168.237.11:9200&quot;]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"3-3-启动应用\"><a href=\"#3-3-启动应用\" class=\"headerlink\" title=\"3.3 启动应用\"></a>3.3 启动应用</h2><figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@192 home]# java -jar dashboard-generate-0.0.1-SNAPSHOT.jar &amp;</span><br></pre></td></tr></table></figure>\n<h2 id=\"3-4-启动elasticsearch\"><a href=\"#3-4-启动elasticsearch\" class=\"headerlink\" title=\"3.4 启动elasticsearch\"></a>3.4 启动elasticsearch</h2><figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[iio@192 bin]$ ./elasticsearch</span><br></pre></td></tr></table></figure>\n<h2 id=\"3-5-启动kibana\"><a href=\"#3-5-启动kibana\" class=\"headerlink\" title=\"3.5 启动kibana\"></a>3.5 启动kibana</h2><figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[iio@192 bin]$ ./kibana</span><br></pre></td></tr></table></figure>\n<h2 id=\"3-6-启动logstash\"><a href=\"#3-6-启动logstash\" class=\"headerlink\" title=\"3.6 启动logstash\"></a>3.6 启动logstash</h2><figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[iio@192 bin]$ ./logstash -f /usr/elastic/logstash/config/logstash-dashboard.yml</span><br></pre></td></tr></table></figure>\n<h2 id=\"3-7-启动filebeat\"><a href=\"#3-7-启动filebeat\" class=\"headerlink\" title=\"3.7 启动filebeat\"></a>3.7 启动filebeat</h2><figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[iio@192 filebeat]$ ./filebeat  -e -c dashboard.yml</span><br></pre></td></tr></table></figure>\n<h2 id=\"3-8-查看采集的数据\"><a href=\"#3-8-查看采集的数据\" class=\"headerlink\" title=\"3.8 查看采集的数据\"></a>3.8 查看采集的数据</h2><p><img src=\"https://image.eelve.com/eblog/2020031401-66d588f9d78f4bf4b34b3d9d0f82001d.png\" alt=\"2020031401\"></p>\n<h2 id=\"3-9-开始制作大屏\"><a href=\"#3-9-开始制作大屏\" class=\"headerlink\" title=\"3.9 开始制作大屏\"></a>3.9 开始制作大屏</h2><p><img src=\"https://image.eelve.com/eblog/2020031402-28114b868ca3470497782f558737d25e.png\" alt=\"2020031402\"><br><img src=\"https://image.eelve.com/eblog/2020031403-7b2ffa7f424b478781543ffb2b1b4207.png\" alt=\"2020031403\"><br><img src=\"https://image.eelve.com/eblog/2020031404-41d668eff3e247e7aa942d850e7775fa.png\" alt=\"2020031404\"><br><img src=\"https://image.eelve.com/eblog/2020031405-2aba46902b5f4495bfae81991385b60d.png\" alt=\"2020031405\"><br><img src=\"https://image.eelve.com/eblog/2020031406-8dbfc5fc883e46298da14ceb8e14348c.png\" alt=\"2020031406\"><br><img src=\"https://image.eelve.com/eblog/2020031407-cd57f9cb79b64ca6acaa2ba604e78511.png\" alt=\"2020031407\"></p>\n<p>到这里我们可以看到就已经完成了对我们自定义数据的监控，然后还利用了Kibana做了图表化展示。</p>\n<hr>\n<p>【<strong>后面的话</strong>】在我们日常应用中，我们的日志需要按照某种规则产生，方便我们使用logstash进行过滤，然后做一些处理。也就是说我们在开发之前就应该想好日志生成的格式，然后设计好日志的处理方式。</p>\n<hr>\n<p><img src=\"https://image.eelve.com/eblog/eblog-b269767ff45b4e01a1c380e38898c1c0.png\" alt=\"薏米笔记\"></p>\n","categories":[{"name":"Elastic Stack","path":"api/categories/Elastic Stack.json"}],"tags":[{"name":"ELK","path":"api/tags/ELK.json"}]}