{"name":"Hyper-V","postlist":[{"title":"Hyper-V和IDEA运行端口占用问题","slug":"Hyper-V和IDEA运行端口占用问题","date":"2020-04-11T04:56:30.000Z","updated":"2021-04-19T06:44:39.035Z","comments":true,"path":"api/articles/Hyper-V和IDEA运行端口占用问题.json","excerpt":null,"keywords":"南国薏米","cover":"https://image.eelve.com/eblog/2020041101-3b9aed15aec84b7e9a0bd3d122c54170.png","content":"<p>【<strong>前面的话</strong>】因为安装Windows版本的Docker环境，开启了Hyper-V。其结果是导致了IDEA在运行Tomcat的时候提示1099端口占用，经过探索之后成功找到了解决方案。</p>\n<h1 id=\"壹、原因分析\"><a href=\"#壹、原因分析\" class=\"headerlink\" title=\"壹、原因分析\"></a>壹、原因分析</h1><p>首先我们可以查看一下我们系统默认的端口占用范围；</p>\n<blockquote>\n<p>netsh int ipv4 show dynamicport tcp</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Microsoft Windows [版本 10.0.18363.752]</span><br><span class=\"line\">(c) 2019 Microsoft Corporation。保留所有权利。</span><br><span class=\"line\"></span><br><span class=\"line\">C:\\Users\\Chirius&gt;netsh int ipv4 show dynamicport tcp</span><br><span class=\"line\"></span><br><span class=\"line\">协议 tcp 动态端口范围</span><br><span class=\"line\">---------------------------------</span><br><span class=\"line\">启动端口        : 1024</span><br><span class=\"line\">端口数          : 13977</span><br></pre></td></tr></table></figure>\n<p>我们可以看到Windows系统默认的tcp 动态端口范围为：1024~13977。当我们开启Hyper-V后，系统默认会分配给一些保留端口供Hyper-V使用：</p>\n<blockquote>\n<p>netsh interface ipv4 show excludedportrange protocol=tcp</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">C:\\Users\\Chirius&gt;netsh interface ipv4 show excludedportrange protocol=tcp</span><br><span class=\"line\">协议 tcp 端口排除范围</span><br><span class=\"line\"> </span><br><span class=\"line\">开始端口    结束端口</span><br><span class=\"line\">----------    --------</span><br><span class=\"line\">      1026        1125</span><br><span class=\"line\">      1226        1325</span><br><span class=\"line\">      1326        1425</span><br><span class=\"line\">      1426        1525</span><br><span class=\"line\">      1526        1625</span><br><span class=\"line\">      2180        2279</span><br></pre></td></tr></table></figure>\n<p>我们可以看到IDEA运行Tomcat需要JMX的<strong>1099</strong>端口刚好在端口排除范围中，这样就导致了IDEA需要使用1099端口是会被占用，这样你当然就不能运行了。</p>\n<h1 id=\"贰、解决方法\"><a href=\"#贰、解决方法\" class=\"headerlink\" title=\"贰、解决方法\"></a>贰、解决方法</h1><p>使用管理员身份运行cmd，重置端口，然后重启</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">C:\\Users\\Chirius&gt;netsh winsock reset</span><br></pre></td></tr></table></figure>\n<p>这样你的tcp端口排除范围可能刚好不包含<strong>1099</strong>端口，这样你当然就可以用你的IDEA运行Tomcat应用了。但是你啥时候会出现就不得而知了。</p>\n<h1 id=\"叁、终极解决\"><a href=\"#叁、终极解决\" class=\"headerlink\" title=\"叁、终极解决\"></a>叁、终极解决</h1><h2 id=\"3-1-关闭Hyper-V\"><a href=\"#3-1-关闭Hyper-V\" class=\"headerlink\" title=\"3.1 关闭Hyper-V\"></a>3.1 关闭Hyper-V</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Microsoft Windows [版本 10.0.18363.752]</span><br><span class=\"line\">(c) 2019 Microsoft Corporation。保留所有权利。</span><br><span class=\"line\"></span><br><span class=\"line\">C:\\WINDOWS\\system32&gt;dism.exe /Online /Disable-Feature:Microsoft-Hyper-V</span><br></pre></td></tr></table></figure>\n<p>或者采用传统方式，在控制面板的“程序和功能”中，找到“Windows功能”，取消Hyper-V的勾选。这两种方法都会要求重启。</p>\n<h2 id=\"3-2-修改动态端口范围\"><a href=\"#3-2-修改动态端口范围\" class=\"headerlink\" title=\"3.2 修改动态端口范围\"></a>3.2 修改动态端口范围</h2><p>使用管理员身份运行cmd</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">C:\\WINDOWS\\system32&gt;netsh int ipv4 <span class=\"built_in\">set</span> dynamicport tcp start=49152 num=16383</span><br><span class=\"line\">确定。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">C:\\WINDOWS\\system32&gt;netsh int ipv4 <span class=\"built_in\">set</span> dynamicport udp start=49152 num=16383</span><br><span class=\"line\">确定。</span><br></pre></td></tr></table></figure>\n<p>然后检查结果</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">C:\\Users\\Chirius&gt;netsh int ipv4 show dynamicport tcp</span><br><span class=\"line\"></span><br><span class=\"line\">协议 tcp 动态端口范围</span><br><span class=\"line\">---------------------------------</span><br><span class=\"line\">启动端口        : 49152</span><br><span class=\"line\">端口数          : 16383</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Microsoft Windows [版本 10.0.18363.752]</span><br><span class=\"line\">(c) 2019 Microsoft Corporation。保留所有权利。</span><br><span class=\"line\"></span><br><span class=\"line\">C:\\Users\\Chirius&gt;netsh interface ipv4 show excludedportrange protocol=tcp</span><br><span class=\"line\"></span><br><span class=\"line\">协议 tcp 端口排除范围</span><br><span class=\"line\"></span><br><span class=\"line\">开始端口    结束端口</span><br><span class=\"line\">----------    --------</span><br><span class=\"line\">      5357        5357</span><br><span class=\"line\">     49702       49801</span><br><span class=\"line\">     49802       49901</span><br><span class=\"line\">     49902       50001</span><br><span class=\"line\">     50051       50051     *</span><br><span class=\"line\">     50052       50151</span><br><span class=\"line\">     50152       50251</span><br><span class=\"line\">     50252       50351</span><br><span class=\"line\">     50352       50451</span><br><span class=\"line\">     50465       50564</span><br><span class=\"line\">     50911       51010</span><br><span class=\"line\"></span><br><span class=\"line\">* - 管理的端口排除。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">C:\\Users\\Chirius&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"3-3-开启Hyper-V\"><a href=\"#3-3-开启Hyper-V\" class=\"headerlink\" title=\"3.3 开启Hyper-V\"></a>3.3 开启Hyper-V</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">C:\\WINDOWS\\system32&gt;dism.exe /Online /Enable-Feature:Microsoft-Hyper-V /All</span><br><span class=\"line\"></span><br><span class=\"line\">部署映像服务和管理工具</span><br><span class=\"line\">版本: 10.0.18362.1</span><br><span class=\"line\"></span><br><span class=\"line\">映像版本: 10.0.18363.752</span><br><span class=\"line\"></span><br><span class=\"line\">启用一个或多个功能</span><br><span class=\"line\">[==========================100.0%==========================]</span><br><span class=\"line\">操作成功完成。</span><br><span class=\"line\">重新启动 Windows 以完成该操作。</span><br><span class=\"line\">是否立即重新启动计算机? (Y/N)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img src=\"https://image.eelve.com/eblog/2020041101-3b9aed15aec84b7e9a0bd3d122c54170.png\" alt=\"开启Hyper-V\"></p>\n<p>或者采用传统方式，在控制面板的“程序和功能”中，找到“Windows功能”，取消Hyper-V的勾选。这两种方法都会要求重启。</p>\n<p>【<strong>后面的话</strong>】使用终极解决方案解决之后，你会发现你的IDEA又可以正常运行了。另外这里说一个单独排除端口的命令，后面可能会用到：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">netsh int ipv4 add excludedportrange protocol=tcp startport=50051 numberofports=1</span><br></pre></td></tr></table></figure>\n<p>使用上面的命令之后我们就可以单独排除某个端口了，保障改端口不会被其他应用占用。</p>\n<hr>\n<p><img src=\"https://image.eelve.com/eblog/eblog-b269767ff45b4e01a1c380e38898c1c0.png\" alt=\"薏米笔记\"></p>\n","raw":null,"categories":[{"name":"Hyper-V","path":"api/categories/Hyper-V.json"}],"tags":[{"name":"yper-V","path":"api/tags/yper-V.json"},{"name":"IDEA","path":"api/tags/IDEA.json"}]}]}