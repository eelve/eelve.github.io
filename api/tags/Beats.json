{"name":"Beats","postlist":[{"title":"Elastic Stack实战之Beats家族介绍","slug":"Elastic-Stack实战之Beats家族介绍","date":"2020-03-05T12:30:10.000Z","updated":"2023-09-30T08:39:39.667Z","comments":true,"path":"api/articles/Elastic-Stack实战之Beats家族介绍.json","excerpt":null,"keywords":"南国薏米","cover":"https://image.eelve.com/eblog/illustration-beats-header-overflow-1ba7ff649dbf41598d71ed24d1ade8da.png","content":"<p>【<strong>前面的话</strong>】前面我们已经体验过了Elasticsearch、Logstash和Kibanan，也是就是ELK三大剑客。记得在前文<a href=\"https://eelve.com/posts/e05eadb0.html\">Elastic Stack实战之Logstash初体验</a>中提到过Elastic Stack大家族中增加了一个新的高效率的采集组件，那就是Beats家族，那今天就来了解一下。</p>\n<hr>\n<h1 id=\"壹、什么是Beats\"><a href=\"#壹、什么是Beats\" class=\"headerlink\" title=\"壹、什么是Beats\"></a>壹、什么是Beats</h1><p><img src=\"https://image.eelve.com/eblog/illustration-beats-header-overflow-1ba7ff649dbf41598d71ed24d1ade8da.png\" alt=\"illustration-beats-header-overflow\"></p>\n<p><strong>Beats</strong>是轻量型数据采集器。</p>\n<p><strong>Beats</strong>平台集合了多种单一用途数据采集器。它们从成百上千或成千上万台机器和系统向 Logstash 或 Elasticsearch 发送数据。 </p>\n<h1 id=\"贰、Beats系列简介\"><a href=\"#贰、Beats系列简介\" class=\"headerlink\" title=\"贰、Beats系列简介\"></a>贰、Beats系列简介</h1><p>全品类采集器，搞定所有数据类型。</p>\n<ul>\n<li><p><a href=\"https://www.elastic.co/beats/filebeat\">Filebeat</a>：用于采集日志文件</p>\n</li>\n<li><p><a href=\"https://www.elastic.co/beats/metricbeat\">Metricbeat</a>: 用于采集指标数据</p>\n</li>\n<li><p><a href=\"https://www.elastic.co/beats/packetbeat\">Packetbeat</a>: 用于采集网络数据</p>\n</li>\n<li><p><a href=\"https://www.elastic.co/beats/winlogbeat\">Winlogbeat</a>: 用于采集Windows事件</p>\n</li>\n<li><p><a href=\"https://www.elastic.co/beats/auditbeat\">Auditbeat</a>: 用于采集审计数据</p>\n</li>\n<li><p><a href=\"https://www.elastic.co/beats/heartbeat\">Heartbeat</a>: 用于采集运行时间监控</p>\n</li>\n<li><p><a href=\"https://www.elastic.co/beats/functionbeat\">Functionbeat</a>: 是一个无需服务器的采集器</p>\n</li>\n</ul>\n<h1 id=\"叁、Beats特点\"><a href=\"#叁、Beats特点\" class=\"headerlink\" title=\"叁、Beats特点\"></a>叁、Beats特点</h1><ul>\n<li>轻量型：Beats 是数据采集的得力工具。将Beats和您的容器一起置于服务器上，或者将Beats作为功能加以部署，然后便可在 Elasticsearch中集中处理数据。Beats能够采集符合 Elastic Common Schema(ECS)要求的数据，如果您希望拥有更加强大的处理能力，Beats能够将数据转发至Logstash进行转换和解析。 </li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/illustration-beats-lightweight-d6ee1493b6a64579a71fb63e2e95b4ac.svg\" alt=\"illustration-beats-lightweight\"></p>\n<ul>\n<li>即插即用：借助模块加速数据可视化体验。Filebeat 和 Metricbeat 中包含的一些模块能够简化从关键数据源（例如云平台、容器和系统，以及网络技术）采集、解析和可视化信息的过程。只需运行一行命令，即可开始探索。 </li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/screenshot-beats-modules-8dec132b351e4c6a9835d806e24e520e.jpg\" alt=\"screenshot-beats-modules\"></p>\n<ul>\n<li>从环境中获得洞见：Beats 从您的专属环境中收集日志和指标，然后通过来自主机、诸如 Docker 和 Kubernetes 等容器平台以及云服务提供商的必要元数据对这些内容进行记录，然后再传输到 Elastic Stack 中。从监测容器到从无需服务器的架构传输数据，我们确保您拥有所需的上下文。 </li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/screenshot-infrastructure-ui-368a637d105b42a4b87d0df2b2158275.png\" alt=\"screenshot-infrastructure-ui\"></p>\n<ul>\n<li>可扩展：缺少某种采集器？别着急。您可以自行构建并分享。每款开源 Beat 都以 libbeat（转发数据时所用的通用库）为基石。需要监控某个专用协议？自行构建。我们将为您提供所需的构建基块。</li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/illustration-beats-exstensible-555-white-bg-1767d533ca824a5290360eb027eed811.svg\" alt=\"illustration-beats-exstensible-555-white-bg\"></p>\n<ul>\n<li>托管式：Beats 同样能向 Elastic Cloud 输送数据</li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/illustration-beats-elasticsearch-service-e783d59f07bc406c95c0942484f91c22.svg\" alt=\"illustration-beats-elasticsearch-service\"></p>\n<hr>\n<p>【<strong>后面的话</strong>】本文只是Beats家族的一个介绍，后面还有相关文章进行体验。Beats采集数据之后可以直接给Elasticsearch，也可以经过Logstash过滤处理之后再由Logstash存入Elasticsearch。在后面的文章会做相应的演示的。</p>\n<hr>\n<p><img src=\"https://image.eelve.com/eblog/eblog-b269767ff45b4e01a1c380e38898c1c0.png\" alt=\"薏米笔记\"></p>\n","raw":null,"categories":[{"name":"Elastic-Stack","path":"api/categories/Elastic-Stack.json"}],"tags":[{"name":"ELK","path":"api/tags/ELK.json"},{"name":"Beats","path":"api/tags/Beats.json"}]},{"title":"Elastic Stack实战之Metricbeat初体验","slug":"Elastic-Stack实战之Metricbeat初体验","date":"2020-03-07T13:36:20.000Z","updated":"2023-09-30T08:39:39.667Z","comments":true,"path":"api/articles/Elastic-Stack实战之Metricbeat初体验.json","excerpt":null,"keywords":"南国薏米","cover":"https://image.eelve.com/eblog/screenshot-infrastructure-ui-d2c3e13f47f74d82a6f0f6c2799d94f8.png","content":"<p>【<strong>前面的话</strong>】<a href=\"https://eelve.com/posts/d1a5ff40.html\">前面介绍了Elastic Stack的Beats家族</a>，并且<a href=\"https://eelve.com/posts/1d8b943d.html\">体验了Filebeat</a>，接下来我们就继续来体验一下</p>\n<hr>\n<h1 id=\"壹、软件版本\"><a href=\"#壹、软件版本\" class=\"headerlink\" title=\"壹、软件版本\"></a>壹、软件版本</h1><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">Centos：CentOS-7-x86_64-Minimal-1908</span></span><br><span class=\"line\"><span class=\"attr\">VM:</span> <span class=\"number\">15.5</span><span class=\"number\">.0</span> <span class=\"string\">build-14665864</span></span><br><span class=\"line\"><span class=\"attr\">Java:</span> <span class=\"number\">1.8</span><span class=\"string\">.0_211</span></span><br><span class=\"line\"><span class=\"attr\">Elasticsearch:</span> <span class=\"string\">elasticsearch-7.6.0</span></span><br><span class=\"line\"><span class=\"attr\">Logstash:</span> <span class=\"string\">logstash-7.6.0</span></span><br><span class=\"line\"><span class=\"attr\">Kibana:</span> <span class=\"string\">kibana-7.6.0</span></span><br><span class=\"line\"><span class=\"string\">MetricBeat：filebeat-7.6.0</span></span><br></pre></td></tr></table></figure>\n<h1 id=\"贰、MetricBeat介绍\"><a href=\"#贰、MetricBeat介绍\" class=\"headerlink\" title=\"贰、MetricBeat介绍\"></a>贰、MetricBeat介绍</h1><p>MetricBeat是一种轻量型指标采集器，用于从系统和服务收集指标。Metricbeat 能够以一种轻量型的方式，输送各种系统和服务统计数据，从 CPU 到内存，从 Redis 到 Nginx，不一而足。</p>\n<ul>\n<li>系统级监控，更简洁</li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/screenshot-infrastructure-ui-d2c3e13f47f74d82a6f0f6c2799d94f8.png\" alt=\"screenshot-infrastructure-ui\"></p>\n<ul>\n<li><p>单个二进制文件提供多种模块</p>\n<p>Metricbeat 提供多种内部模块，这些模块可从多项服务（诸如 Apache、Jolokia、NGINX、MongoDB、MySQL、PostgreSQL、Prometheus 等等）中收集指标。安装简单，完全零依赖性。只需在配置文件中启用您所需的模块即可。</p>\n<p>而且，如果您没有看到要找的模块，还可以自己构建。以 Go 语言编写 Metricbeat 模块，过程十分简单。 </p>\n<ul>\n<li>系统</li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/metricbeat-modules-system-7f76e2200cfb40089bb112f50aae710e.jpg\" alt=\"metricbeat-modules-system\"></p>\n<ul>\n<li>Docker</li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/container-monitoring-screenshot-carousel-docker-908943a547964d11996a9775855235f0.jpg\" alt=\"container-monitoring-screenshot-carousel-docker\"></p>\n<ul>\n<li>MongoDB</li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/metricbeat-modules-mongo-d5d719649a7a4e2a9bf9f1a984528efc.jpg\" alt=\"metricbeat-modules-mongo\"></p>\n<ul>\n<li>Kubernetes</li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/container-monitoring-screenshot-carousel-kubernetes-0ee5a1fdacf74c3b82d12c81c5c14af1.jpg\" alt=\"container-monitoring-screenshot-carousel-kubernetes\"></p>\n</li>\n<li><p>容器就绪 </p>\n<p>近来是不是所有工作都转移到了 Docker 中？通过 Elastic Stack，您能够轻松地监测容器。将 Metricbeat 部署到同一台主机上的一个单独容器后，它将收集与主机上运行的其他每一个容器相关的统计数据。在收集统计数据时，它直接从 proc 文件系统读取 cgroup 信息，这就意味着它无需特权即可访问 Docker API，并且同样适用于其他 Runtime。针对 Docker 的 Autodiscovery 让事情进一步简化，您只需指定一个条件即可开启 Metricbeat 模块。 </p>\n</li>\n<li><p>不错过任何检测信号</p>\n<p>将指标通过假脱机传输方式输送至磁盘，这样您的数据管道再也不会错过任何一个数据点，即使发生中断（例如网络问题），也勿需担心。Metricbeat 会保留传入的数据，并在重新上线后将这些指标输送至 Elasticsearch 或 Logstash。 </p>\n</li>\n</ul>\n<ul>\n<li><p>输送至 Elasticsearch 或 Logstash。在 Kibana 中实现可视化。</p>\n<p>Metricbeat 是 Elastic Stack 的一部分，因此能够与 Logstash、Elasticsearch 和 Kibana 无缝协作。无论您要使用 Logstash 转换或充实指标，还是在 Elasticsearch 中随意处理一些数据分析，亦或在 Kibana 中构建和分享仪表板，Metricbeat 都能轻松地将您的数据发送至最关键的地方。</p>\n</li>\n</ul>\n<h1 id=\"叁-MetricBeat安装\"><a href=\"#叁-MetricBeat安装\" class=\"headerlink\" title=\"叁 MetricBeat安装\"></a>叁 MetricBeat安装</h1><h2 id=\"3-1-下载地址\"><a href=\"#3-1-下载地址\" class=\"headerlink\" title=\"3.1 下载地址\"></a>3.1 下载地址</h2><p><a href=\"https://artifacts.elastic.co/downloads/beats/filebeat/metricBeat-7.6.0-linux-x86_64.tar.gz\">metricBeat-7.6.0-linux-x86_64</a></p>\n<h2 id=\"3-2-解压metricBeat-7-6-0-linux-x86-64\"><a href=\"#3-2-解压metricBeat-7-6-0-linux-x86-64\" class=\"headerlink\" title=\"3.2 解压metricBeat-7.6.0-linux-x86_64\"></a>3.2 解压metricBeat-7.6.0-linux-x86_64</h2><figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar -zvxf metricBeat-7.6.0-linux-x86_64.tar.gz -C /usr/elastic</span><br></pre></td></tr></table></figure>\n<h2 id=\"3-3-使用Kibana展示Metricbeat系统指标\"><a href=\"#3-3-使用Kibana展示Metricbeat系统指标\" class=\"headerlink\" title=\"3.3 使用Kibana展示Metricbeat系统指标\"></a>3.3 使用Kibana展示Metricbeat系统指标</h2><ul>\n<li>修改Metricbeat配置</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">output.elasticsearch:</span><br><span class=\"line\"><span class=\"meta\">  #</span><span class=\"bash\"> Array of hosts to connect to.</span></span><br><span class=\"line\">  hosts: [&quot;http://192.168.237.11:9200&quot;]</span><br></pre></td></tr></table></figure>\n<ul>\n<li>启动</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[iio@192 metricbeat]$ ./metricbeat -e</span><br></pre></td></tr></table></figure>\n<ul>\n<li>在Elasticsearch中查看采集的数据</li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/2020030707-906f151d4ab34f7c8bbcfea65d83f8e9.png\" alt=\"2020030707\"></p>\n<ul>\n<li>修改Metricbeat配置</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">setup.kibana:</span><br><span class=\"line\">  host: &quot;192.168.237.11:5601&quot;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>安装仪表盘</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./metricbeat setup --dashboards</span><br></pre></td></tr></table></figure>\n<ul>\n<li>重启服务查看效果</li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/2020030708-ba77ee4e36c6478c8b816a314d730f80.png\" alt=\"2020030708\"><br><img src=\"https://image.eelve.com/eblog/2020030709-a40f0d5711fc4707a416e2c39bbbcb79.png\" alt=\"2020030709\"></p>\n<p>到这里我们就监控了我们系统的指标，并且利用Kibana提供的仪表板做了图形化展示。</p>\n<h2 id=\"3-4-使用Kibana展示Metricbeat采集nginx指标\"><a href=\"#3-4-使用Kibana展示Metricbeat采集nginx指标\" class=\"headerlink\" title=\"3.4 使用Kibana展示Metricbeat采集nginx指标\"></a>3.4 使用Kibana展示Metricbeat采集nginx指标</h2><ul>\n<li><p>开启nginx的状态查询</p>\n<p>在nginx中，需要开启状态查询，才能查询到指标数据。</p>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">重新编译nginx</span></span><br><span class=\"line\">./configure --prefix=/usr/local/nginx --with-http_stub_status_module</span><br><span class=\"line\">make</span><br><span class=\"line\">make install</span><br><span class=\"line\"></span><br><span class=\"line\">./nginx -V #查询版本信息</span><br><span class=\"line\">nginx version: nginx/1.12.0</span><br><span class=\"line\">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-39) (GCC) </span><br><span class=\"line\">configure arguments: --prefix=/usr/local/nginx/ --with-http_stub_status_module</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">配置nginx</span></span><br><span class=\"line\">vi nginx.conf</span><br><span class=\"line\">location /nginx-status &#123;</span><br><span class=\"line\">    stub_status on;</span><br><span class=\"line\">    access_log off;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://image.eelve.com/eblog/2020030710-267475b4b77648ccb8d57c0fece62055.png\" alt=\"2020030710\"></p>\n<p>结果说明：</p>\n<ul>\n<li>Active connections：正在处理的活动连接数</li>\n<li>server accepts handled requests<ul>\n<li>第一个 server 表示Nginx启动到现在共处理了22个连接</li>\n<li>第二个 accepts 表示Nginx启动到现在共成功创建 22 次握手</li>\n<li>第三个 handled requests 表示总共处理了 193 次请求</li>\n<li>请求丢失数 = 握手数 - 连接数 ，可以看出目前为止没有丢失请求</li>\n</ul>\n</li>\n<li>Reading: 0 Writing: 1 Waiting: 2<ul>\n<li>Reading：Nginx 读取到客户端的 Header 信息数</li>\n<li>Writing：Nginx 返回给客户端 Header 信息数</li>\n<li>Waiting：Nginx 已经处理完正在等候下一次请求指令的驻留链接（开启keep-alive的情况下，这个值等于 Active - (Reading+Writing)）</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<ul>\n<li><p>配置Nginx Module</p>\n<p>默认Metricbeat之开启了system modules，所以我们这里要手动启用nginx modules</p>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./metricbeat modules enable nginx</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[iio@192 metricbeat]$ ./metricbeat modules list</span><br><span class=\"line\">Enabled:</span><br><span class=\"line\">nginx</span><br><span class=\"line\">system</span><br><span class=\"line\"></span><br><span class=\"line\">Disabled:</span><br><span class=\"line\">activemq</span><br><span class=\"line\">aerospike</span><br><span class=\"line\">apache</span><br><span class=\"line\">appsearch</span><br><span class=\"line\">aws</span><br><span class=\"line\">azure</span><br><span class=\"line\">beat</span><br><span class=\"line\">beat-xpack</span><br><span class=\"line\">ceph</span><br><span class=\"line\">cockroachdb</span><br><span class=\"line\">consul</span><br><span class=\"line\">coredns</span><br><span class=\"line\">couchbase</span><br><span class=\"line\">couchdb</span><br><span class=\"line\">docker</span><br><span class=\"line\">dropwizard</span><br><span class=\"line\">elasticsearch</span><br><span class=\"line\">elasticsearch-xpack</span><br><span class=\"line\">envoyproxy</span><br><span class=\"line\">etcd</span><br><span class=\"line\">golang</span><br><span class=\"line\">googlecloud</span><br><span class=\"line\">graphite</span><br><span class=\"line\">haproxy</span><br><span class=\"line\">http</span><br><span class=\"line\">jolokia</span><br><span class=\"line\">kafka</span><br><span class=\"line\">kibana</span><br><span class=\"line\">kibana-xpack</span><br><span class=\"line\">kubernetes</span><br><span class=\"line\">kvm</span><br><span class=\"line\">logstash</span><br><span class=\"line\">logstash-xpack</span><br><span class=\"line\">memcached</span><br><span class=\"line\">mongodb</span><br><span class=\"line\">mssql</span><br><span class=\"line\">munin</span><br><span class=\"line\">mysql</span><br><span class=\"line\">nats</span><br><span class=\"line\">oracle</span><br><span class=\"line\">php_fpm</span><br><span class=\"line\">postgresql</span><br><span class=\"line\">prometheus</span><br><span class=\"line\">rabbitmq</span><br><span class=\"line\">redis</span><br><span class=\"line\">sql</span><br><span class=\"line\">stan</span><br><span class=\"line\">statsd</span><br><span class=\"line\">tomcat</span><br><span class=\"line\">traefik</span><br><span class=\"line\">uwsgi</span><br><span class=\"line\">vsphere</span><br><span class=\"line\">windows</span><br><span class=\"line\">zookeeper</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>修改nginx modules的配置</p>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[iio@192 modules.d]$ vi nginx.yml </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> Module: nginx</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> Docs: https://www.elastic.co/guide/en/beats/metricbeat/7.6/metricbeat-module-nginx.html</span></span><br><span class=\"line\"></span><br><span class=\"line\">- module: nginx</span><br><span class=\"line\"><span class=\"meta\">  #</span><span class=\"bash\">metricsets:</span></span><br><span class=\"line\"><span class=\"meta\">  #</span><span class=\"bash\">  - stubstatus</span></span><br><span class=\"line\">  period: 10s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span><span class=\"bash\"> Nginx hosts</span></span><br><span class=\"line\">  hosts: [&quot;http://192.168.237.11&quot;]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span><span class=\"bash\"> Path to server status. Default server-status</span></span><br><span class=\"line\">  server_status_path: &quot;nginx-status&quot; #配置的nginx状态访问地址</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span><span class=\"bash\">username: <span class=\"string\">&quot;user&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">  #</span><span class=\"bash\">password: <span class=\"string\">&quot;secret&quot;</span></span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n<li><p>启动测试</p>\n</li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/2020030711-c1217270b05241ca96fa42f063ba8d9f.png\" alt=\"2020030711\"><br><img src=\"https://image.eelve.com/eblog/2020030712-8ae5730e5301448b974d67545ff98e7a.png\" alt=\"2020030712\"></p>\n<p>到这里我们采集的nginx的指标数据，并且利用Kibana安装的Metricbeatd的nginx仪表盘做了图形化展示。</p>\n<h1 id=\"肆、Metricbeat组成\"><a href=\"#肆、Metricbeat组成\" class=\"headerlink\" title=\"肆、Metricbeat组成\"></a>肆、Metricbeat组成</h1><p>Metricbeat有2部分组成，一部分是Module，另一部分为Metricset。</p>\n<ul>\n<li><p>Module</p>\n<p>收集的对象，如：mysql、redis、nginx、操作系统等；</p>\n</li>\n<li><p>Metricset</p>\n<p>收集指标的集合，如：cpu、memory、network等；  </p>\n</li>\n</ul>\n<hr>\n<p>【<strong>后面的话</strong>】在本文中我们利用Metricbeat监控了系统和nginx的系统指标，并且做了图标化的展示。其他module的使用也类似，他们都是利用Metricbeat给被监控的机器放松状态指令，然后采集数据，再做图形化的展示。同时我们也看到Merticbeat也内置了很多的module，足够了我们日工作需要了。</p>\n<hr>\n<p><img src=\"https://image.eelve.com/eblog/eblog-b269767ff45b4e01a1c380e38898c1c0.png\" alt=\"薏米笔记\"></p>\n","raw":null,"categories":[{"name":"Elastic-Stack","path":"api/categories/Elastic-Stack.json"}],"tags":[{"name":"ELK","path":"api/tags/ELK.json"},{"name":"Beats","path":"api/tags/Beats.json"},{"name":"MetricBeat","path":"api/tags/MetricBeat.json"}]},{"title":"Elastic Stack实战之Filebeat初体验","slug":"Elastic-Stack实战之Filebeat初体验","date":"2020-03-07T09:49:22.000Z","updated":"2023-09-30T08:39:39.667Z","comments":true,"path":"api/articles/Elastic-Stack实战之Filebeat初体验.json","excerpt":null,"keywords":"南国薏米","cover":"https://image.eelve.com/eblog/animated-gif-logs-ui-optimized-7bf3c88845c84ee3a0564f7a608726b5.gif","content":"<p>【<strong>前面的话</strong>】<a href=\"https://eelve.com/posts/d1a5ff40.html\">前文</a>介绍了Elastic Stack的Beats家族，今天我们就来体验其中的专门用于采集文件的<a href=\"https://www.elastic.co/cn/beats/filebeat\">Filebeat</a>，走起。</p>\n<hr>\n<h1 id=\"壹、软件版本\"><a href=\"#壹、软件版本\" class=\"headerlink\" title=\"壹、软件版本\"></a>壹、软件版本</h1><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">Centos：CentOS-7-x86_64-Minimal-1908</span></span><br><span class=\"line\"><span class=\"attr\">VM:</span> <span class=\"number\">15.5</span><span class=\"number\">.0</span> <span class=\"string\">build-14665864</span></span><br><span class=\"line\"><span class=\"attr\">Java:</span> <span class=\"number\">1.8</span><span class=\"string\">.0_211</span></span><br><span class=\"line\"><span class=\"attr\">Elasticsearch:</span> <span class=\"string\">elasticsearch-7.6.0</span></span><br><span class=\"line\"><span class=\"attr\">Logstash:</span> <span class=\"string\">logstash-7.6.0</span></span><br><span class=\"line\"><span class=\"attr\">Kibana:</span> <span class=\"string\">kibana-7.6.0</span></span><br><span class=\"line\"><span class=\"string\">Filebeat：filebeat-7.6.0</span></span><br></pre></td></tr></table></figure>\n<h1 id=\"贰、Filebeat介绍\"><a href=\"#贰、Filebeat介绍\" class=\"headerlink\" title=\"贰、Filebeat介绍\"></a>贰、Filebeat介绍</h1><p>Filebeat是一种轻量型日志采集器，具有以下特点</p>\n<ul>\n<li>汇总、“tail -f”和搜索：启动 Filebeat 后，打开 Logs UI，直接在 Kibana 中观看对您的文件进行 tail 操作的过程。通过搜索栏按照服务、应用程序、主机、数据中心或者其他条件进行筛选，以跟踪您的全部汇总日志中的异常行为。</li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/animated-gif-logs-ui-optimized-7bf3c88845c84ee3a0564f7a608726b5.gif\" alt=\"animated-gif-logs-ui-optimized\"></p>\n<ul>\n<li><p>性能稳健，不错过任何检测信号：无论在任何环境中，随时都潜伏着应用程序中断的风险。Filebeat 能够读取并转发日志行，如果出现中断，还会在一切恢复正常后，从中断前停止的位置继续开始。</p>\n</li>\n<li><p>Filebeat 让简单的事情简单化：Filebeat 内置有多种模块（Apache、Cisco ASA、Microsoft Azure、NGINX、MySQL 等等），可针对常见格式的日志大大简化收集、解析和可视化过程，只需一条命令即可。之所以能实现这一点，是因为它将自动默认路径（因操作系统而异）与 Elasticsearch 采集节点管道的定义和 Kibana 仪表板组合在一起。不仅如此，数个 Filebeat 模块还包括预配置的 Machine Learning 任务。 </p>\n<ul>\n<li>系统</li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/filebeat-modules-system-1fcfe648ed244a3eb6981805e48eb805.jpg\" alt=\"filebeat-modules-system\"></p>\n<ul>\n<li>NGINX</li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/filebeat-modules-nginx-60aafcc8bf6e416e8489e30b85e84446.jpg\" alt=\"filebeat-modules-nginx\"></p>\n<ul>\n<li>MySQL</li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/filebeat-modules-mysql-532077e16cc3495291fbe4c7b15e7f36.jpg\" alt=\"filebeat-modules-mysql\"></p>\n<ul>\n<li>Auditd</li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/filebeat-modules-auditd-593f8272484b4aa4ac01bc3fcd596d43.jpg\" alt=\"filebeat-modules-auditd\"></p>\n</li>\n</ul>\n<ul>\n<li><p>容器就绪和云端就绪：正在对所有内容进行容器化，或者正在云端环境中运行？通过 Elastic Stack，可以轻松地监测容器和云服务。在 Kubernetes、Docker 或云端部署中部署 Filebeat，即可获得所有的日志流：信息十分完整，包括日志流的 pod、容器、节点、VM、主机以及自动关联时用到的其他元数据。此外，Beats Autodiscover 功能可检测到新容器，并使用恰当的 Filebeat 模块对这些容器进行自适应监测。 </p>\n</li>\n<li><p>它不会导致您的管道过载：当将数据发送到 Logstash 或 Elasticsearch 时，Filebeat 使用背压敏感协议，以应对更多的数据量。如果 Logstash 正在忙于处理数据，则会告诉 Filebeat 减慢读取速度。一旦拥堵得到解决，Filebeat 就会恢复到原来的步伐并继续传输数据。 </p>\n</li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/filebeat-diagram-71397eba004043f3a0593620b0139364.svg\" alt=\"filebeat-diagram\"></p>\n<ul>\n<li><p>输送至 Elasticsearch 或 Logstash。在 Kibana 中实现可视化。</p>\n<p>Filebeat 是 Elastic Stack 的一部分，因此能够与 Logstash、Elasticsearch 和 Kibana 无缝协作。无论您要使用 Logstash 转换或充实日志和文件，还是在 Elasticsearch 中随意处理一些数据分析，亦或在 Kibana 中构建和分享仪表板，Filebeat 都能轻松地将您的数据发送至最关键的地方。</p>\n</li>\n</ul>\n<h1 id=\"叁-Filebeat安装\"><a href=\"#叁-Filebeat安装\" class=\"headerlink\" title=\"叁 Filebeat安装\"></a>叁 Filebeat安装</h1><h2 id=\"3-1-下载地址\"><a href=\"#3-1-下载地址\" class=\"headerlink\" title=\"3.1 下载地址\"></a>3.1 下载地址</h2><p><a href=\"https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.6.0-linux-x86_64.tar.gz\">filebeat-7.6.0-linux-x86_64</a></p>\n<h2 id=\"3-2-解压filebeat-7-6-0-linux-x86-64\"><a href=\"#3-2-解压filebeat-7-6-0-linux-x86-64\" class=\"headerlink\" title=\"3.2 解压filebeat-7.6.0-linux-x86_64\"></a>3.2 解压filebeat-7.6.0-linux-x86_64</h2><figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar -zvxf filebeat-7.6.0-linux-x86_64.tar.gz -C /usr/elastic</span><br></pre></td></tr></table></figure>\n<h2 id=\"3-3-filebeat配置\"><a href=\"#3-3-filebeat配置\" class=\"headerlink\" title=\"3.3 filebeat配置\"></a>3.3 filebeat配置</h2><p>我们可以针对不同的采集项自定义配置，同时方便测试和展示。</p>\n<h2 id=\"3-4-采集控制台日志\"><a href=\"#3-4-采集控制台日志\" class=\"headerlink\" title=\"3.4 采集控制台日志\"></a>3.4 采集控制台日志</h2><ul>\n<li>新建std.yml配置</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">filebeat.inputs:</span><br><span class=\"line\">- type: stdin</span><br><span class=\"line\">  enabled: true</span><br><span class=\"line\">setup.template.settings:</span><br><span class=\"line\">  index.number_of_shards: 1</span><br><span class=\"line\">output.console:</span><br><span class=\"line\">  pretty: true</span><br><span class=\"line\">  enable: true</span><br></pre></td></tr></table></figure>\n<ul>\n<li>启动</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./filebeat  -e -c std.yml</span><br></pre></td></tr></table></figure>\n<ul>\n<li>结果</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hello</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;@timestamp&quot;: &quot;2020-03-07T08:40:10.807Z&quot;,</span><br><span class=\"line\">  &quot;@metadata&quot;: &#123;</span><br><span class=\"line\">    &quot;beat&quot;: &quot;filebeat&quot;,</span><br><span class=\"line\">    &quot;type&quot;: &quot;_doc&quot;,</span><br><span class=\"line\">    &quot;version&quot;: &quot;7.6.0&quot;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;agent&quot;: &#123;</span><br><span class=\"line\">    &quot;id&quot;: &quot;4f346e18-c77b-4a8c-ae9a-f97b2007be60&quot;,</span><br><span class=\"line\">    &quot;version&quot;: &quot;7.6.0&quot;,</span><br><span class=\"line\">    &quot;type&quot;: &quot;filebeat&quot;,</span><br><span class=\"line\">    &quot;ephemeral_id&quot;: &quot;2b5dd30b-1a9a-454a-a9f1-0a428fd6c6da&quot;,</span><br><span class=\"line\">    &quot;hostname&quot;: &quot;192.168.237.11&quot;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;ecs&quot;: &#123;</span><br><span class=\"line\">    &quot;version&quot;: &quot;1.4.0&quot;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;message&quot;: &quot;hello&quot;,</span><br><span class=\"line\">  &quot;log&quot;: &#123;</span><br><span class=\"line\">    &quot;offset&quot;: 0,</span><br><span class=\"line\">    &quot;file&quot;: &#123;</span><br><span class=\"line\">      &quot;path&quot;: &quot;&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;input&quot;: &#123;</span><br><span class=\"line\">    &quot;type&quot;: &quot;stdin&quot;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;host&quot;: &#123;</span><br><span class=\"line\">    &quot;name&quot;: &quot;192.168.237.11&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"3-5-采集nginx日志\"><a href=\"#3-5-采集nginx日志\" class=\"headerlink\" title=\"3.5 采集nginx日志\"></a>3.5 采集nginx日志</h2><ul>\n<li><p>启动nginx</p>\n<p>这里如果没有安装的话，可以自行安装配置，然后启动nginx</p>\n</li>\n<li><p>新建nginx.yml配置</p>\n</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">filebeat.inputs:</span><br><span class=\"line\">- type: log</span><br><span class=\"line\">  enabled: true</span><br><span class=\"line\">  paths:</span><br><span class=\"line\">    - /usr/local/nginx/logs/*.log</span><br><span class=\"line\">  tags: [&quot;nginx&quot;]</span><br><span class=\"line\">setup.template.settings:</span><br><span class=\"line\">  index.number_of_shards: 1</span><br><span class=\"line\">output.elasticsearch:</span><br><span class=\"line\">  hosts: [&quot;http://192.168.237.11:9200&quot;]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul>\n<li>启动Elasticsearch</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[iio@192 bin]$ ./elasticsearch</span><br></pre></td></tr></table></figure>\n<ul>\n<li>启动Filebeat</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[iio@192 filebeat]$ ./filebeat  -e -c nginx.yml</span><br><span class=\"line\"></span><br><span class=\"line\">2020-03-07T17:11:05.821+0800\tINFO\tinstance/beat.go:298\tSetup Beat: filebeat; Version: 7.6.0</span><br><span class=\"line\">2020-03-07T17:11:05.821+0800\tINFO\t[index-management]\tidxmgmt/std.go:182\tSet output.elasticsearch.index to &#x27;filebeat-7.6.0&#x27; as ILM is enabled.</span><br><span class=\"line\">2020-03-07T17:11:05.821+0800\tINFO\telasticsearch/client.go:174\tElasticsearch url: http://192.168.237.11:9200</span><br><span class=\"line\">2020-03-07T17:11:05.821+0800\tINFO\t[publisher]\tpipeline/module.go:110\tBeat name: 192.168.237.11</span><br><span class=\"line\">2020-03-07T17:11:05.822+0800\tINFO\t[monitoring]\tlog/log.go:118\tStarting metrics logging every 30s</span><br><span class=\"line\">2020-03-07T17:11:05.822+0800\tINFO\tinstance/beat.go:439\tfilebeat start running.</span><br><span class=\"line\">2020-03-07T17:11:05.822+0800\tINFO\tregistrar/registrar.go:145\tLoading registrar data from /usr/elastic/filebeat/data/registry/filebeat/data.json</span><br><span class=\"line\">2020-03-07T17:11:05.822+0800\tINFO\tregistrar/registrar.go:152\tStates Loaded from registrar: 3</span><br><span class=\"line\">2020-03-07T17:11:05.822+0800\tINFO\tcrawler/crawler.go:72\tLoading Inputs: 1</span><br><span class=\"line\">2020-03-07T17:11:05.823+0800\tINFO\tlog/input.go:152\tConfigured paths: [/usr/local/nginx/logs/*.log]</span><br><span class=\"line\">2020-03-07T17:11:05.823+0800\tINFO\tinput/input.go:114\tStarting input of type: log; ID: 11194696681404026286 </span><br><span class=\"line\">2020-03-07T17:11:05.823+0800\tINFO\tcrawler/crawler.go:106\tLoading and starting Inputs completed. Enabled inputs: 1</span><br><span class=\"line\">2020-03-07T17:11:15.826+0800\tINFO\tlog/harvester.go:297\tHarvester started for file: /usr/local/nginx/logs/access.log</span><br><span class=\"line\">2020-03-07T17:11:16.828+0800\tINFO\tpipeline/output.go:95\tConnecting to backoff(elasticsearch(http://192.168.237.11:9200))</span><br><span class=\"line\">2020-03-07T17:11:16.831+0800\tINFO\telasticsearch/client.go:757\tAttempting to connect to Elasticsearch version 7.6.0</span><br><span class=\"line\">2020-03-07T17:11:16.859+0800\tINFO\t[license]\tlicenser/es_callback.go:50\tElasticsearch license: Basic</span><br><span class=\"line\">2020-03-07T17:11:16.891+0800\tINFO\t[index-management]\tidxmgmt/std.go:258\tAuto ILM enable success.</span><br><span class=\"line\">2020-03-07T17:11:16.892+0800\tINFO\t[index-management.ilm]\tilm/std.go:139\tdo not generate ilm policy: exists=true, overwrite=false</span><br><span class=\"line\">2020-03-07T17:11:16.893+0800\tINFO\t[index-management]\tidxmgmt/std.go:271\tILM policy successfully loaded.</span><br><span class=\"line\">2020-03-07T17:11:16.893+0800\tINFO\t[index-management]\tidxmgmt/std.go:410\tSet setup.template.name to &#x27;&#123;filebeat-7.6.0 &#123;now/d&#125;-000001&#125;&#x27; as ILM is enabled.</span><br><span class=\"line\">2020-03-07T17:11:16.893+0800\tINFO\t[index-management]\tidxmgmt/std.go:415\tSet setup.template.pattern to &#x27;filebeat-7.6.0-*&#x27; as ILM is enabled.</span><br><span class=\"line\">2020-03-07T17:11:16.893+0800\tINFO\t[index-management]\tidxmgmt/std.go:449\tSet settings.index.lifecycle.rollover_alias in template to &#123;filebeat-7.6.0 &#123;now/d&#125;-000001&#125; as ILM is enabled.</span><br><span class=\"line\">2020-03-07T17:11:16.893+0800\tINFO\t[index-management]\tidxmgmt/std.go:453\tSet settings.index.lifecycle.name in template to &#123;filebeat &#123;&quot;policy&quot;:&#123;&quot;phases&quot;:&#123;&quot;hot&quot;:&#123;&quot;actions&quot;:&#123;&quot;rollover&quot;:&#123;&quot;max_age&quot;:&quot;30d&quot;,&quot;max_size&quot;:&quot;50gb&quot;&#125;&#125;&#125;&#125;&#125;&#125;&#125; as ILM is enabled.</span><br><span class=\"line\">2020-03-07T17:11:16.895+0800\tINFO\ttemplate/load.go:89\tTemplate filebeat-7.6.0 already exists and will not be overwritten.</span><br><span class=\"line\">2020-03-07T17:11:16.895+0800\tINFO\t[index-management]\tidxmgmt/std.go:295\tLoaded index template.</span><br><span class=\"line\">2020-03-07T17:11:17.097+0800\tINFO\t[index-management]\tidxmgmt/std.go:306\tWrite alias successfully generated.</span><br><span class=\"line\">2020-03-07T17:11:17.097+0800\tINFO\tpipeline/output.go:105\tConnection to backoff(elasticsearch(http://192.168.237.11:9200)) established</span><br></pre></td></tr></table></figure>\n<ul>\n<li>刷新页面观察结果</li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/2020030701-f6f0c410456c47e7872c7719e1fe4205.png\" alt=\"2020030701\"><br><img src=\"https://image.eelve.com/eblog/2020030702-c17fe51d42ca47a3b4c452fa14131e92.png\" alt=\"2020030702\"></p>\n<p>我们可以看到采集已经成功，并且我们配置的tags也已经成功了</p>\n<h2 id=\"3-6-使用nginx-module采集nginx日志\"><a href=\"#3-6-使用nginx-module采集nginx日志\" class=\"headerlink\" title=\"3.6 使用nginx module采集nginx日志\"></a>3.6 使用nginx module采集nginx日志</h2><ul>\n<li>开启filebeat的nginx module</li>\n</ul>\n<p>前面要想实现日志数据的读取以及处理都是自己手动配置的，其实，在Filebeat中，有大量的Module，可以简化我们的配置，直接就可以使用，如下：</p>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[iio@192 filebeat]$ ./filebeat modules list</span><br><span class=\"line\">Enabled:</span><br><span class=\"line\">nginx</span><br><span class=\"line\"></span><br><span class=\"line\">Disabled:</span><br><span class=\"line\">activemq</span><br><span class=\"line\">apache</span><br><span class=\"line\">auditd</span><br><span class=\"line\">aws</span><br><span class=\"line\">azure</span><br><span class=\"line\">cef</span><br><span class=\"line\">cisco</span><br><span class=\"line\">coredns</span><br><span class=\"line\">elasticsearch</span><br><span class=\"line\">envoyproxy</span><br><span class=\"line\">googlecloud</span><br><span class=\"line\">haproxy</span><br><span class=\"line\">ibmmq</span><br><span class=\"line\">icinga</span><br><span class=\"line\">iis</span><br><span class=\"line\">iptables</span><br><span class=\"line\">kafka</span><br><span class=\"line\">kibana</span><br><span class=\"line\">logstash</span><br><span class=\"line\">misp</span><br><span class=\"line\">mongodb</span><br><span class=\"line\">mssql</span><br><span class=\"line\">mysql</span><br><span class=\"line\">nats</span><br><span class=\"line\">netflow</span><br><span class=\"line\">osquery</span><br><span class=\"line\">panw</span><br><span class=\"line\">postgresql</span><br><span class=\"line\">rabbitmq</span><br><span class=\"line\">redis</span><br><span class=\"line\">santa</span><br><span class=\"line\">suricata</span><br><span class=\"line\">system</span><br><span class=\"line\">traefik</span><br><span class=\"line\">zeek</span><br></pre></td></tr></table></figure>\n<p>可以看到我这里的nginx modules已经开启了，但是默认是没有开启的，如果需要启用需要进行enable操作：</p>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/filebeat modules enable nginx #启动</span><br><span class=\"line\">./filebeat modules disable nginx #禁用</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul>\n<li>nginx module 配置</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[iio@192 filebeat]$ cd modules.d</span><br><span class=\"line\">[iio@192 modules.d]$ vi nginx.yml </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> Module: nginx</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> Docs: https://www.elastic.co/guide/en/beats/filebeat/7.6/filebeat-module-nginx.html</span></span><br><span class=\"line\"></span><br><span class=\"line\">- module: nginx</span><br><span class=\"line\"><span class=\"meta\">  #</span><span class=\"bash\"> Access logs</span></span><br><span class=\"line\">  access:</span><br><span class=\"line\">    enabled: true</span><br><span class=\"line\">    var.paths: [&quot;/usr/local/nginx/logs/access.log*&quot;]</span><br><span class=\"line\">    # Set custom paths for the log files. If left empty,</span><br><span class=\"line\">    # Filebeat will choose the paths depending on your OS.</span><br><span class=\"line\">    #var.paths:</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span><span class=\"bash\"> Error logs</span></span><br><span class=\"line\">  error:</span><br><span class=\"line\">    enabled: true</span><br><span class=\"line\">    var.paths: [&quot;/usr/local/nginx/logs/error.log*&quot;]</span><br><span class=\"line\"></span><br><span class=\"line\">    # Set custom paths for the log files. If left empty,</span><br><span class=\"line\">    # Filebeat will choose the paths depending on your OS.</span><br><span class=\"line\">    #var.paths:</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul>\n<li>配置filebeat</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[iio@192 filebeat]$ vi nginxmodule.yml</span><br><span class=\"line\">filebeat.inputs:</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">- <span class=\"built_in\">type</span>: <span class=\"built_in\">log</span></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">  enabled: <span class=\"literal\">true</span></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">  paths:</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">    - /usr/<span class=\"built_in\">local</span>/nginx/logs/*.<span class=\"built_in\">log</span></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">  tags: [<span class=\"string\">&quot;nginx&quot;</span>]</span></span><br><span class=\"line\">setup.template.settings:</span><br><span class=\"line\">  index.number_of_shards: 1</span><br><span class=\"line\">output.elasticsearch:</span><br><span class=\"line\">  hosts: [&quot;http://192.168.237.11:9200&quot;]</span><br><span class=\"line\">filebeat.config.modules:</span><br><span class=\"line\">  path: $&#123;path.config&#125;/modules.d/*.yml</span><br><span class=\"line\">  reload.enabled: false</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul>\n<li>启动</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[iio@192 filebeat]$ ./filebeat  -e -c nginxmodule.yml</span><br></pre></td></tr></table></figure>\n<ul>\n<li>查看结果</li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/2020030703-14356801335d4ea8a4256bce80a9bf5f.png\" alt=\"2020030703\"></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">\t&quot;msg&quot;: &quot;2020-02-29 02:30:26,634 [myid:] - WARN  [NIOServerCxn.Factory:0.0.0.0\\&#x2F;0.0.0.0:2181:NIOServerCnxn@376] - Unable to read additional data from client sessionid 0x0, likely client has closed socket&quot;,</span><br><span class=\"line\">\t&quot;rawmsg&quot;: &quot;2020-02-29 02:30:26,634 [myid:] - WARN  [NIOServerCxn.Factory:0.0.0.0\\&#x2F;0.0.0.0:2181:NIOServerCnxn@376] - Unable to read additional data from client sessionid 0x0, likely client has closed socket&quot;,</span><br><span class=\"line\">\t&quot;timereported&quot;: &quot;2020-02-29T10:30:26.635186+08:00&quot;,</span><br><span class=\"line\">\t&quot;hostname&quot;: &quot;izbp1a4b02uc2nj550yzs1z&quot;,</span><br><span class=\"line\">\t&quot;syslogtag&quot;: &quot;journal:&quot;,</span><br><span class=\"line\">\t&quot;inputname&quot;: &quot;imjournal&quot;,</span><br><span class=\"line\">\t&quot;fromhost&quot;: &quot;izbp1a4b02uc2nj550yzs1z&quot;,</span><br><span class=\"line\">\t&quot;fromhost-ip&quot;: &quot;127.0.0.1&quot;,</span><br><span class=\"line\">\t&quot;pri&quot;: &quot;14&quot;,</span><br><span class=\"line\">\t&quot;syslogfacility&quot;: &quot;1&quot;,</span><br><span class=\"line\">\t&quot;syslogseverity&quot;: &quot;6&quot;,</span><br><span class=\"line\">\t&quot;timegenerated&quot;: &quot;2020-02-29T10:30:26.635186+08:00&quot;,</span><br><span class=\"line\">\t&quot;programname&quot;: &quot;journal&quot;,</span><br><span class=\"line\">\t&quot;protocol-version&quot;: &quot;0&quot;,</span><br><span class=\"line\">\t&quot;structured-data&quot;: &quot;-&quot;,</span><br><span class=\"line\">\t&quot;app-name&quot;: &quot;journal&quot;,</span><br><span class=\"line\">\t&quot;procid&quot;: &quot;-&quot;,</span><br><span class=\"line\">\t&quot;msgid&quot;: &quot;-&quot;,</span><br><span class=\"line\">\t&quot;uuid&quot;: null,</span><br><span class=\"line\">\t&quot;$!&quot;: &#123;</span><br><span class=\"line\">\t\t&quot;_UID&quot;: &quot;0&quot;,</span><br><span class=\"line\">\t\t&quot;_GID&quot;: &quot;0&quot;,</span><br><span class=\"line\">\t\t&quot;_CAP_EFFECTIVE&quot;: &quot;1fffffffff&quot;,</span><br><span class=\"line\">\t\t&quot;_BOOT_ID&quot;: &quot;1c6d86e336cc4dc7b733ea3c53351d65&quot;,</span><br><span class=\"line\">\t\t&quot;_MACHINE_ID&quot;: &quot;f0f31005fb5a436d88e3c6cbf54e25aa&quot;,</span><br><span class=\"line\">\t\t&quot;_HOSTNAME&quot;: &quot;izbp1a4b02uc2nj550yzs1z&quot;,</span><br><span class=\"line\">\t\t&quot;_SYSTEMD_SLICE&quot;: &quot;system.slice&quot;,</span><br><span class=\"line\">\t\t&quot;PRIORITY&quot;: &quot;6&quot;,</span><br><span class=\"line\">\t\t&quot;_TRANSPORT&quot;: &quot;journal&quot;,</span><br><span class=\"line\">\t\t&quot;CONTAINER_ID_FULL&quot;: &quot;bdc76f9b56dbeb3f5005ca110d72945c6b949178b6948345febf5bc657433703&quot;,</span><br><span class=\"line\">\t\t&quot;CONTAINER_NAME&quot;: &quot;zookeeper&quot;,</span><br><span class=\"line\">\t\t&quot;CONTAINER_TAG&quot;: &quot;bdc76f9b56db&quot;,</span><br><span class=\"line\">\t\t&quot;CONTAINER_ID&quot;: &quot;bdc76f9b56db&quot;,</span><br><span class=\"line\">\t\t&quot;_PID&quot;: &quot;16046&quot;,</span><br><span class=\"line\">\t\t&quot;_COMM&quot;: &quot;dockerd-current&quot;,</span><br><span class=\"line\">\t\t&quot;_EXE&quot;: &quot;\\&#x2F;usr\\&#x2F;bin\\&#x2F;dockerd-current&quot;,</span><br><span class=\"line\">\t\t&quot;_CMDLINE&quot;: &quot;\\&#x2F;usr\\&#x2F;bin\\&#x2F;dockerd-current --add-runtime docker-runc&#x3D;\\&#x2F;usr\\&#x2F;libexec\\&#x2F;docker\\&#x2F;docker-runc-current --default-runtime&#x3D;docker-runc --exec-opt native.cgroupdriver&#x3D;systemd --userland-proxy-path&#x3D;\\&#x2F;usr\\&#x2F;libexec\\&#x2F;docker\\&#x2F;docker-proxy-current --init-path&#x3D;\\&#x2F;usr\\&#x2F;libexec\\&#x2F;docker\\&#x2F;docker-init-current --seccomp-profile&#x3D;\\&#x2F;etc\\&#x2F;docker\\&#x2F;seccomp.json --selinux-enabled --log-driver&#x3D;journald --signature-verification&#x3D;false --storage-driver overlay2&quot;,</span><br><span class=\"line\">\t\t&quot;_SYSTEMD_CGROUP&quot;: &quot;\\&#x2F;system.slice\\&#x2F;docker.service&quot;,</span><br><span class=\"line\">\t\t&quot;_SYSTEMD_UNIT&quot;: &quot;docker.service&quot;,</span><br><span class=\"line\">\t\t&quot;MESSAGE&quot;: &quot;2020-02-29 02:30:26,634 [myid:] - WARN  [NIOServerCxn.Factory:0.0.0.0\\&#x2F;0.0.0.0:2181:NIOServerCnxn@376] - Unable to read additional data from client sessionid 0x0, likely client has closed socket&quot;,</span><br><span class=\"line\">\t\t&quot;_SOURCE_REALTIME_TIMESTAMP&quot;: &quot;1582943426634852&quot;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125; &#123;</span><br><span class=\"line\">\t&quot;_index&quot;: &quot;filebeat-7.6.0-2020.03.07-000001&quot;,</span><br><span class=\"line\">\t&quot;_type&quot;: &quot;_doc&quot;,</span><br><span class=\"line\">\t&quot;_id&quot;: &quot;hBtStHAB2wqxgggKYbTw&quot;,</span><br><span class=\"line\">\t&quot;_version&quot;: 1,</span><br><span class=\"line\">\t&quot;_score&quot;: 1,</span><br><span class=\"line\">\t&quot;_source&quot;: &#123;</span><br><span class=\"line\">\t\t&quot;agent&quot;: &#123;</span><br><span class=\"line\">\t\t\t&quot;hostname&quot;: &quot;192.168.237.11&quot;,</span><br><span class=\"line\">\t\t\t&quot;id&quot;: &quot;4f346e18-c77b-4a8c-ae9a-f97b2007be60&quot;,</span><br><span class=\"line\">\t\t\t&quot;ephemeral_id&quot;: &quot;b9759c98-cfbe-4240-8c7d-1e64c1caeec3&quot;,</span><br><span class=\"line\">\t\t\t&quot;type&quot;: &quot;filebeat&quot;,</span><br><span class=\"line\">\t\t\t&quot;version&quot;: &quot;7.6.0&quot;</span><br><span class=\"line\">\t\t&#125;,</span><br><span class=\"line\">\t\t&quot;nginx&quot;: &#123;</span><br><span class=\"line\">\t\t\t&quot;access&quot;: &#123;</span><br><span class=\"line\">\t\t\t\t&quot;remote_ip_list&quot;: [</span><br><span class=\"line\">\t\t\t\t\t&quot;192.168.237.1&quot;</span><br><span class=\"line\">\t\t\t\t]</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;,</span><br><span class=\"line\">\t\t&quot;log&quot;: &#123;</span><br><span class=\"line\">\t\t\t&quot;file&quot;: &#123;</span><br><span class=\"line\">\t\t\t\t&quot;path&quot;: &quot;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;access.log&quot;</span><br><span class=\"line\">\t\t\t&#125;,</span><br><span class=\"line\">\t\t\t&quot;offset&quot;: 83567</span><br><span class=\"line\">\t\t&#125;,</span><br><span class=\"line\">\t\t&quot;source&quot;: &#123;</span><br><span class=\"line\">\t\t\t&quot;address&quot;: &quot;192.168.237.1&quot;,</span><br><span class=\"line\">\t\t\t&quot;ip&quot;: &quot;192.168.237.1&quot;</span><br><span class=\"line\">\t\t&#125;,</span><br><span class=\"line\">\t\t&quot;fileset&quot;: &#123;</span><br><span class=\"line\">\t\t\t&quot;name&quot;: &quot;access&quot;</span><br><span class=\"line\">\t\t&#125;,</span><br><span class=\"line\">\t\t&quot;url&quot;: &#123;</span><br><span class=\"line\">\t\t\t&quot;original&quot;: &quot;&#x2F;&quot;</span><br><span class=\"line\">\t\t&#125;,</span><br><span class=\"line\">\t\t&quot;input&quot;: &#123;</span><br><span class=\"line\">\t\t\t&quot;type&quot;: &quot;log&quot;</span><br><span class=\"line\">\t\t&#125;,</span><br><span class=\"line\">\t\t&quot;@timestamp&quot;: &quot;2020-03-07T09:27:40.000Z&quot;,</span><br><span class=\"line\">\t\t&quot;ecs&quot;: &#123;</span><br><span class=\"line\">\t\t\t&quot;version&quot;: &quot;1.4.0&quot;</span><br><span class=\"line\">\t\t&#125;,</span><br><span class=\"line\">\t\t&quot;service&quot;: &#123;</span><br><span class=\"line\">\t\t\t&quot;type&quot;: &quot;nginx&quot;</span><br><span class=\"line\">\t\t&#125;,</span><br><span class=\"line\">\t\t&quot;host&quot;: &#123;</span><br><span class=\"line\">\t\t\t&quot;name&quot;: &quot;192.168.237.11&quot;</span><br><span class=\"line\">\t\t&#125;,</span><br><span class=\"line\">\t\t&quot;http&quot;: &#123;</span><br><span class=\"line\">\t\t\t&quot;request&quot;: &#123;</span><br><span class=\"line\">\t\t\t\t&quot;referrer&quot;: &quot;-&quot;,</span><br><span class=\"line\">\t\t\t\t&quot;method&quot;: &quot;GET&quot;</span><br><span class=\"line\">\t\t\t&#125;,</span><br><span class=\"line\">\t\t\t&quot;response&quot;: &#123;</span><br><span class=\"line\">\t\t\t\t&quot;status_code&quot;: 304,</span><br><span class=\"line\">\t\t\t\t&quot;body&quot;: &#123;</span><br><span class=\"line\">\t\t\t\t\t&quot;bytes&quot;: 0</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;,</span><br><span class=\"line\">\t\t\t&quot;version&quot;: &quot;1.1&quot;</span><br><span class=\"line\">\t\t&#125;,</span><br><span class=\"line\">\t\t&quot;event&quot;: &#123;</span><br><span class=\"line\">\t\t\t&quot;timezone&quot;: &quot;+08:00&quot;,</span><br><span class=\"line\">\t\t\t&quot;created&quot;: &quot;2020-03-07T09:27:41.512Z&quot;,</span><br><span class=\"line\">\t\t\t&quot;module&quot;: &quot;nginx&quot;,</span><br><span class=\"line\">\t\t\t&quot;dataset&quot;: &quot;nginx.access&quot;</span><br><span class=\"line\">\t\t&#125;,</span><br><span class=\"line\">\t\t&quot;user&quot;: &#123;</span><br><span class=\"line\">\t\t\t&quot;name&quot;: &quot;-&quot;</span><br><span class=\"line\">\t\t&#125;,</span><br><span class=\"line\">\t\t&quot;user_agent&quot;: &#123;</span><br><span class=\"line\">\t\t\t&quot;original&quot;: &quot;Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;80.0.3987.132 Safari&#x2F;537.36&quot;,</span><br><span class=\"line\">\t\t\t&quot;os&quot;: &#123;</span><br><span class=\"line\">\t\t\t\t&quot;name&quot;: &quot;Windows&quot;,</span><br><span class=\"line\">\t\t\t\t&quot;version&quot;: &quot;10&quot;,</span><br><span class=\"line\">\t\t\t\t&quot;full&quot;: &quot;Windows 10&quot;</span><br><span class=\"line\">\t\t\t&#125;,</span><br><span class=\"line\">\t\t\t&quot;name&quot;: &quot;Chrome&quot;,</span><br><span class=\"line\">\t\t\t&quot;device&quot;: &#123;</span><br><span class=\"line\">\t\t\t\t&quot;name&quot;: &quot;Other&quot;</span><br><span class=\"line\">\t\t\t&#125;,</span><br><span class=\"line\">\t\t\t&quot;version&quot;: &quot;80.0.3987.132&quot;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>我们开用使用filebeat提供的modules采集nginx日志也成功,而且可以看到展示的信息也更加完善了。可以看到filebeat提供的各种modules就是帮我们做了一些解析工作，其他modules的用法类似。</p>\n<h2 id=\"3-7-使用Kibana展示\"><a href=\"#3-7-使用Kibana展示\" class=\"headerlink\" title=\"3.7 使用Kibana展示\"></a>3.7 使用Kibana展示</h2><ul>\n<li>修改filebeat配置</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[iio@192 filebeat]$ vi iio.yml </span><br><span class=\"line\"></span><br><span class=\"line\">filebeat.inputs:</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">- <span class=\"built_in\">type</span>: <span class=\"built_in\">log</span></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">  enabled: <span class=\"literal\">true</span></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">  paths:</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">    - /usr/<span class=\"built_in\">local</span>/nginx/logs/*.<span class=\"built_in\">log</span></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">  tags: [<span class=\"string\">&quot;nginx&quot;</span>]</span></span><br><span class=\"line\">setup.template.settings:</span><br><span class=\"line\">  index.number_of_shards: 1</span><br><span class=\"line\">output.elasticsearch:</span><br><span class=\"line\">  hosts: [&quot;http://192.168.237.11:9200&quot;]</span><br><span class=\"line\">filebeat.config.modules:</span><br><span class=\"line\">  path: $&#123;path.config&#125;/modules.d/*.yml</span><br><span class=\"line\">  reload.enabled: false</span><br><span class=\"line\">setup.kibana:</span><br><span class=\"line\">  host: &quot;192.168.237.11:5601&quot;</span><br><span class=\"line\">~   </span><br></pre></td></tr></table></figure>\n<ul>\n<li>启动Kibana</li>\n</ul>\n<p>下面的安装仪表板依赖Kibana，也就是Kibana必须启动才能安装仪表盘</p>\n<ul>\n<li>安装仪表盘</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#安装仪表盘到Kibana</span><br><span class=\"line\">.&#x2F;metricbeat setup --dashboards</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://image.eelve.com/eblog/2020030704-84aabcd7f21a4af0ab1ccb694e2f5f47.png\" alt=\"2020030704\"></p>\n<ul>\n<li>启动Filebeat</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./filebeat  -e -c iio.yml</span><br></pre></td></tr></table></figure>\n<ul>\n<li>观察结果</li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/2020030705-77c1f59279aa40d4b8319560da4a6ae5.png\" alt=\"2020030705\"><br><img src=\"https://image.eelve.com/eblog/2020030706-9f858efbcaba4dd898b07e54c2f42a0d.png\" alt=\"2020030706\"></p>\n<p>可以看到Kibana内置的nginx的仪表盘的展示情况，展示相当仿佛，并且还可以随着时间变化而刷新</p>\n<h1 id=\"肆、Filebeat工作原理\"><a href=\"#肆、Filebeat工作原理\" class=\"headerlink\" title=\"肆、Filebeat工作原理\"></a>肆、Filebeat工作原理</h1><p>Filebeat由两个主要组件组成：prospector 和 harvester。</p>\n<ul>\n<li><p>harvester：</p>\n<ul>\n<li>负责读取单个文件的内容。</li>\n<li>如果文件在读取时被删除或重命名，Filebeat将继续读取文件。</li>\n</ul>\n</li>\n<li><p>prospector：</p>\n<ul>\n<li>prospector 负责管理harvester并找到所有要读取的文件来源。</li>\n<li>如果输入类型为日志，则查找器将查找路径匹配的所有文件，并为每个文件启动一个harvester。</li>\n<li>Filebeat目前支持两种prospector类型：log和stdin。</li>\n</ul>\n</li>\n<li><p>Filebeat如何保持文件的状态</p>\n<ul>\n<li>Filebeat 保存每个文件的状态并经常将状态刷新到磁盘上的注册文件中。</li>\n<li>该状态用于记住harvester正在读取的最后偏移量，并确保发送所有日志行。</li>\n<li>如果输出（例如Elasticsearch或Logstash）无法访问，Filebeat会跟踪最后发送的行，并在输出再次可用时继续读取文件。</li>\n<li>在Filebeat运行时，每个prospector内存中也会保存的文件状态信息，当重新启动Filebeat时，将使用注册</li>\n<li>文件的数据来重建文件状态，Filebeat将每个harvester在从保存的最后偏移量继续读取。</li>\n<li>文件状态记录在data/registry文件中。</li>\n</ul>\n<p>```shell script<br>启动命令<br>./filebeat -e -c itcast.yml<br>./filebeat -e -c itcast.yml -d “publish”<br>#参数说明</p>\n</li>\n<li><p>e: 输出到标准输出,默认输出到syslog和logs下</p>\n</li>\n<li><p>c: 指定配置文件</p>\n</li>\n<li><p>d: 输出debug信息</p>\n</li>\n</ul>\n<p>#测试： ./filebeat -e -c iio.yml -d “publish”</p>\n<pre><code>\n---\n\n【**后面的话**】在本文中我们全面的体验了一下filebeat，还和Kibana结合应用了，我们可以看到filebeat和elk三大剑客整合的非常好，特别是Kibana提供了丰富的仪表盘，大大的方便了我们展示。后面还有再结合一下Logstash，使用以下过滤功能。\n\n---\n\n![薏米笔记](https://image.eelve.com/eblog/eblog-b269767ff45b4e01a1c380e38898c1c0.png)\n</code></pre>\n","raw":null,"categories":[{"name":"Elastic-Stack","path":"api/categories/Elastic-Stack.json"}],"tags":[{"name":"ELK","path":"api/tags/ELK.json"},{"name":"Beats","path":"api/tags/Beats.json"},{"name":"FileBeat","path":"api/tags/FileBeat.json"}]}]}