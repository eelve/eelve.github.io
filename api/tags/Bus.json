{"name":"Bus","postlist":[{"title":"SpringCloud之消息总线","slug":"SpringCloud之消息总线","date":"2019-08-31T06:34:42.000Z","updated":"2023-09-30T08:39:39.682Z","comments":true,"path":"api/articles/SpringCloud之消息总线.json","excerpt":null,"keywords":"南国薏米","cover":"https://i.loli.net/2019/08/30/efY37U8EdqP2VNA.png","content":"<p>【<strong>前面的话</strong>】书接上文<a href=\"https://eelve.com/posts/f1275148.html\">SpringCloud之Config</a>，如果没有看过可以先移步去看一下。在上一篇文章中提到了配置刷新的问题，如果需要刷新配置就需要客户端执行<strong>refresh</strong>，我们可以利用<strong>webhook</strong>的机制每次提交代码发送请求来刷新客户端，当客户端越来越多的时候，需要每个客户端都执行一遍，这种方案就不太适合了。使用Spring Cloud Bus可以完美解决这一问题。</p>\n<hr>\n<h1 id=\"壹、Spring-Cloud-Bus的简介\"><a href=\"#壹、Spring-Cloud-Bus的简介\" class=\"headerlink\" title=\"壹、Spring Cloud Bus的简介\"></a>壹、Spring Cloud Bus的简介</h1><p>Spring cloud bus通过轻量消息代理连接各个分布的节点。这会用在广播状态的变化（例如配置变化）或者其他的消息指令。Spring bus的一个核心思想是通过分布式的启动器对spring boot应用进行扩展，也可以用来建立一个多个应用之间的通信频道。目前唯一实现的方式是用AMQP消息代理作为通道，同样特性的设置（有些取决于通道的设置）在更多通道的文档中。</p>\n<h1 id=\"贰、解决方案\"><a href=\"#贰、解决方案\" class=\"headerlink\" title=\"贰、解决方案\"></a>贰、解决方案</h1><h2 id=\"方案一：\"><a href=\"#方案一：\" class=\"headerlink\" title=\"方案一：\"></a>方案一：</h2><ul>\n<li>Spring cloud bus被国内很多都翻译为消息总线，也挺形象的。大家可以将它理解为管理和传播所有分布式项目中的消息既可，其实本质是利用了MQ的广播机制在分布式的系统中传播消息，目前常用的有Kafka和RabbitMQ。利用bus的机制可以做很多的事情，其中配置中心客户端刷新就是典型的应用场景之一，我们用一张图来描述bus在配置中心使用的机制。</li>\n</ul>\n<p><img src=\"https://i.loli.net/2019/08/30/efY37U8EdqP2VNA.png\" alt=\"方案一流程图\"></p>\n<p>根据此图我们可以看出利用Spring Cloud Bus做配置更新的步骤:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、提交代码触发post给客户端A发送&#x2F;actuator&#x2F;bus-refresh</span><br><span class=\"line\">2、客户端A接收到请求从Server端更新配置并且发送给Spring Cloud Bus</span><br><span class=\"line\">3、Spring Cloud bus接到消息并通知给其它客户端</span><br><span class=\"line\">4、其它客户端接收到通知，请求Server端获取最新配置</span><br><span class=\"line\">5、全部客户端均获取到最新的配置</span><br></pre></td></tr></table></figure>\n<h2 id=\"方案二：\"><a href=\"#方案二：\" class=\"headerlink\" title=\"方案二：\"></a>方案二：</h2><ul>\n<li><p>在方案一中我们已经到达了利用消息总线触发一个客户端/actuator/bus-refresh,而刷新所有客户端的配置的目的。但这种方式并不优雅。原因如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">打破了微服务的职责单一性。微服务本身是业务模块，它本不应该承担配置刷新的职责。</span><br><span class=\"line\">破坏了微服务各节点的对等性。</span><br><span class=\"line\">有一定的局限性。例如，微服务在迁移时，它的网络地址常常会发生变化，此时如果想要做到自动刷新，那就不得不修改WebHook的配置。</span><br></pre></td></tr></table></figure>\n<p> 因此我们将方案一的架构模式稍微改变一下</p>\n<p><img src=\"https://i.loli.net/2019/08/30/If9PwxiMWRo7mZC.png\" alt=\"方案二流程图\"></p>\n<p>这时Spring Cloud Bus做配置更新步骤如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、提交代码触发post请求给bus&#x2F;refresh</span><br><span class=\"line\">2、server端接收到请求并发送给Spring Cloud Bus</span><br><span class=\"line\">3、Spring Cloud bus接到消息并通知给其它客户端</span><br><span class=\"line\">4、其它客户端接收到通知，请求Server端获取最新配置</span><br><span class=\"line\">5、全部客户端均获取到最新的配置</span><br></pre></td></tr></table></figure>\n<p>下面我们就采用方案二来改造我们的工程，这样的话我们在server端的代码做一些改动，来支持bus/refresh</p>\n<h1 id=\"叁、改造服务端\"><a href=\"#叁、改造服务端\" class=\"headerlink\" title=\"叁、改造服务端\"></a>叁、改造服务端</h1></li>\n</ul>\n<ul>\n<li>改造上文的config的服务端子工程<strong>lovin-config-server</strong>，添加RabbitMQ的依赖。下面是改造后的主要的pom依赖:</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;parent&gt;</span><br><span class=\"line\">        &lt;artifactId&gt;lovincloud&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">        &lt;groupId&gt;com.eelve.lovincloud&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">        &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class=\"line\">    &lt;&#x2F;parent&gt;</span><br><span class=\"line\">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;artifactId&gt;lovin-config-server&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">    &lt;packaging&gt;jar&lt;&#x2F;packaging&gt;</span><br><span class=\"line\">    &lt;name&gt;lovinconfigserver&lt;&#x2F;name&gt;</span><br><span class=\"line\">    &lt;version&gt;0.0.1&lt;&#x2F;version&gt;</span><br><span class=\"line\">    &lt;description&gt;配置服务端&lt;&#x2F;description&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;dependencies&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">        &lt;&#x2F;dependency&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;spring-boot-starter-security&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">        &lt;&#x2F;dependency&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">        &lt;&#x2F;dependency&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;de.codecentric&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;spring-boot-admin-starter-client&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">            &lt;version&gt;2.1.6&lt;&#x2F;version&gt;</span><br><span class=\"line\">        &lt;&#x2F;dependency&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;spring-cloud-config-server&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">        &lt;&#x2F;dependency&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;spring-cloud-starter-bus-amqp&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">        &lt;&#x2F;dependency&gt;</span><br><span class=\"line\">    &lt;&#x2F;dependencies&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;build&gt;</span><br><span class=\"line\">        &lt;plugins&gt;</span><br><span class=\"line\">            &lt;plugin&gt;</span><br><span class=\"line\">                &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">            &lt;&#x2F;plugin&gt;</span><br><span class=\"line\">        &lt;&#x2F;plugins&gt;</span><br><span class=\"line\">    &lt;&#x2F;build&gt;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>添加rabbitmq的连接配置</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">server:</span></span><br><span class=\"line\">  <span class=\"attr\">port:</span> <span class=\"number\">8886</span>   <span class=\"comment\"># 服务端口号</span></span><br><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">application:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">lovinconfigserver</span>     <span class=\"comment\"># 服务名称</span></span><br><span class=\"line\">  <span class=\"attr\">security:</span></span><br><span class=\"line\">    <span class=\"attr\">basic:</span></span><br><span class=\"line\">      <span class=\"attr\">enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"attr\">user:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">lovin</span></span><br><span class=\"line\">      <span class=\"attr\">password:</span> <span class=\"string\">$&#123;REGISTRY_SERVER_PASSWORD:lovin&#125;</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">config:</span></span><br><span class=\"line\">      <span class=\"attr\">server:</span></span><br><span class=\"line\">        <span class=\"attr\">git:</span></span><br><span class=\"line\">          <span class=\"attr\">uri:</span> <span class=\"string\">https://github.com/lovinstudio/lovincloud</span></span><br><span class=\"line\">          <span class=\"attr\">search-paths:</span> <span class=\"string\">lovin-config-repo</span></span><br><span class=\"line\">      <span class=\"attr\">label:</span> <span class=\"string\">master</span></span><br><span class=\"line\">  <span class=\"attr\">rabbitmq:</span></span><br><span class=\"line\">    <span class=\"attr\">host:</span> <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">5672</span></span><br><span class=\"line\">    <span class=\"attr\">username:</span> <span class=\"string\">guest</span></span><br><span class=\"line\">    <span class=\"attr\">password:</span> <span class=\"string\">guest</span></span><br><span class=\"line\"><span class=\"attr\">eureka:</span></span><br><span class=\"line\">  <span class=\"attr\">client:</span></span><br><span class=\"line\">    <span class=\"attr\">serviceUrl:</span></span><br><span class=\"line\">      <span class=\"attr\">defaultZone:</span> <span class=\"string\">http://lovin:lovin@localhost:8881/eureka/</span>   <span class=\"comment\"># 注册到的eureka服务地址</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"肆、改造配置客户端\"><a href=\"#肆、改造配置客户端\" class=\"headerlink\" title=\"肆、改造配置客户端\"></a>肆、改造配置客户端</h1><ul>\n<li>改造上文的config的服务端子工程<strong>lovin-config-client</strong>，添加RabbitMQ的依赖。下面是改造后的主要的pom依赖:</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    &lt;parent&gt;</span><br><span class=\"line\">        &lt;artifactId&gt;lovincloud&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">        &lt;groupId&gt;com.eelve.lovincloud&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">        &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class=\"line\">    &lt;&#x2F;parent&gt;</span><br><span class=\"line\">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;artifactId&gt;lovin-config-client&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">    &lt;packaging&gt;jar&lt;&#x2F;packaging&gt;</span><br><span class=\"line\">    &lt;name&gt;lovinconfigclient&lt;&#x2F;name&gt;</span><br><span class=\"line\">    &lt;version&gt;0.0.1&lt;&#x2F;version&gt;</span><br><span class=\"line\">    &lt;description&gt;配置消费端&lt;&#x2F;description&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;dependencies&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">        &lt;&#x2F;dependency&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;spring-boot-starter-security&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">        &lt;&#x2F;dependency&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">        &lt;&#x2F;dependency&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;de.codecentric&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;spring-boot-admin-starter-client&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">            &lt;version&gt;2.1.6&lt;&#x2F;version&gt;</span><br><span class=\"line\">        &lt;&#x2F;dependency&gt;</span><br><span class=\"line\">&lt;!--        &lt;dependency&gt;--&gt;</span><br><span class=\"line\">&lt;!--            &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;--&gt;</span><br><span class=\"line\">&lt;!--            &lt;artifactId&gt;spring-cloud-config-server&lt;&#x2F;artifactId&gt;--&gt;</span><br><span class=\"line\">&lt;!--        &lt;&#x2F;dependency&gt;--&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;spring-cloud-starter-config&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">            &lt;version&gt;2.1.3.RELEASE&lt;&#x2F;version&gt;</span><br><span class=\"line\">        &lt;&#x2F;dependency&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;spring-boot-starter-actuator&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">        &lt;&#x2F;dependency&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;spring-cloud-starter-bus-amqp&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">        &lt;&#x2F;dependency&gt;</span><br><span class=\"line\">    &lt;&#x2F;dependencies&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;build&gt;</span><br><span class=\"line\">        &lt;plugins&gt;</span><br><span class=\"line\">            &lt;plugin&gt;</span><br><span class=\"line\">                &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class=\"line\">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;&#x2F;artifactId&gt;</span><br><span class=\"line\">            &lt;&#x2F;plugin&gt;</span><br><span class=\"line\">        &lt;&#x2F;plugins&gt;</span><br><span class=\"line\">    &lt;&#x2F;build&gt;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>添加连接rabbitmq的相关配置</li>\n</ul>\n<ol>\n<li>修改<strong>bootstrap.yml</strong>添加连接rabbitmq的配置</li>\n</ol>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">server:</span></span><br><span class=\"line\">  <span class=\"attr\">port:</span> <span class=\"number\">8807</span>   <span class=\"comment\"># 服务端口号</span></span><br><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">application:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">lovinconfigclient</span>     <span class=\"comment\"># 服务名称</span></span><br><span class=\"line\">  <span class=\"attr\">security:</span></span><br><span class=\"line\">    <span class=\"attr\">basic:</span></span><br><span class=\"line\">      <span class=\"attr\">enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"attr\">user:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">lovin</span></span><br><span class=\"line\">      <span class=\"attr\">password:</span> <span class=\"string\">$&#123;REGISTRY_SERVER_PASSWORD:lovin&#125;</span></span><br><span class=\"line\"><span class=\"comment\">#eureka:</span></span><br><span class=\"line\"><span class=\"comment\">#  client:</span></span><br><span class=\"line\"><span class=\"comment\">#    serviceUrl:</span></span><br><span class=\"line\"><span class=\"comment\">#      defaultZone: http://lovin:lovin@localhost:8881/eureka/   # 注册到的eureka服务地址</span></span><br><span class=\"line\">  <span class=\"attr\">rabbitmq:</span></span><br><span class=\"line\">    <span class=\"attr\">host:</span> <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">5672</span></span><br><span class=\"line\">    <span class=\"attr\">username:</span> <span class=\"string\">guest</span></span><br><span class=\"line\">    <span class=\"attr\">password:</span> <span class=\"string\">guest</span></span><br></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li>修改<strong>application.yml</strong>开启消息跟踪</li>\n</ol>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">config:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">lovin-config</span></span><br><span class=\"line\">      <span class=\"attr\">profile:</span> <span class=\"string\">dev</span></span><br><span class=\"line\">      <span class=\"comment\">#uri: http://localhost:8886/</span></span><br><span class=\"line\">      <span class=\"comment\">#label: master</span></span><br><span class=\"line\">      <span class=\"attr\">discovery:</span></span><br><span class=\"line\">        <span class=\"attr\">enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">        <span class=\"attr\">service-id:</span> <span class=\"string\">lovinconfigserver</span></span><br><span class=\"line\">    <span class=\"attr\">bus:</span></span><br><span class=\"line\">      <span class=\"attr\">trace:</span></span><br><span class=\"line\">        <span class=\"attr\">enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">eureka:</span></span><br><span class=\"line\">  <span class=\"attr\">client:</span></span><br><span class=\"line\">    <span class=\"attr\">serviceUrl:</span></span><br><span class=\"line\">      <span class=\"attr\">defaultZone:</span> <span class=\"string\">http://lovin:lovin@localhost:8881/eureka/</span>   <span class=\"comment\"># 注意在高可用的时候需要见注册中心配置移到该文件中，在application.yml中见会读取不到配置</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h1 id=\"伍、启动测试\"><a href=\"#伍、启动测试\" class=\"headerlink\" title=\"伍、启动测试\"></a>伍、启动测试</h1><ul>\n<li><p>1.首先依次启动lovin-eureka-server、lovin-econfig-server、lovin-econfig-client</p>\n</li>\n<li><p>2.查看lovin-econfig-server查询配置</p>\n</li>\n</ul>\n<p><img src=\"https://i.loli.net/2019/08/30/dQinHZMc5LARPGu.png\" alt=\"查看lovin-econfig-server查询配置\"></p>\n<ul>\n<li>3.查看lovin-econfig-client查询配置</li>\n</ul>\n<p><img src=\"https://i.loli.net/2019/08/30/3i1ELfl6buBnvqm.png\" alt=\"查看lovin-econfig-client查询配置\"></p>\n<ul>\n<li>4.修改配置，并提交见token的值由lovin改为lovinupdate</li>\n</ul>\n<p><img src=\"https://i.loli.net/2019/08/30/FQblZJdPM3eTDj7.png\" alt=\"修改token\"></p>\n<ul>\n<li>5.再次查看lovin-econfig-server查询配置</li>\n</ul>\n<p><img src=\"https://i.loli.net/2019/08/30/DfESYQXoy4bp3sw.png\" alt=\"再次查询服务端\"></p>\n<ul>\n<li>6.再次查看lovin-econfig-client查询配置</li>\n</ul>\n<p><img src=\"https://i.loli.net/2019/08/30/YUCThEAD3Mlvkxg.png\" alt=\"再次查询客户端\"></p>\n<ul>\n<li>7.刷新消息总线</li>\n</ul>\n<p>由于api变更，url由老版本的/bus/refresh变为actuator/bus-refresh</p>\n<p><img src=\"https://i.loli.net/2019/08/30/2qcYG5hDRwX1L9d.png\" alt=\"属性消息总线\"></p>\n<ul>\n<li>8.再次查看lovin-econfig-client查询配置</li>\n</ul>\n<p><img src=\"https://i.loli.net/2019/08/30/Rq1jtT5cVfdZlP6.png\" alt=\"再次查看客户端配置\"></p>\n<p>我们可以看到已经刷新成功，至此消息总线配置已经完成</p>\n<h1 id=\"陆、局部刷新\"><a href=\"#陆、局部刷新\" class=\"headerlink\" title=\"陆、局部刷新\"></a>陆、局部刷新</h1><p>某些场景下（例如灰度发布），我们可能只想刷新部分微服务的配置，此时可通过/actuator/bus-refresh端点的destination参数来定位要刷新的应用程序。</p>\n<ul>\n<li>例如：/actuator/bus-refresh?destination=customers:8000，这样消息总线上的微服务实例就会根据destination参数的值来判断是否需要要刷新。其中，customers:8000指的是各个微服务的ApplicationContext ID。destination参数也可以用来定位特定的微服务。</li>\n<li>例如：/actuator/bus-refresh?destination=customers:**，这样就可以触发customers微服务所有实例的配置刷新。</li>\n</ul>\n<hr>\n<ul>\n<li><a href=\"https://github.com/lovinstudio/lovincloud\">最后的最后是本博客的源码,欢迎关注这一套SpringCloud的实践</a></li>\n</ul>\n<hr>\n<p><img src=\"https://image.eelve.com/eblog/eblog-b269767ff45b4e01a1c380e38898c1c0.png\" alt=\"薏米笔记\"></p>\n","raw":null,"categories":[{"name":"SpringCloud","path":"api/categories/SpringCloud.json"}],"tags":[{"name":"Bus","path":"api/tags/Bus.json"}]}]}