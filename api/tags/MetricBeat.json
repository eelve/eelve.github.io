{"name":"MetricBeat","postlist":[{"title":"Elastic Stack实战之Metricbeat初体验","slug":"Elastic-Stack实战之Metricbeat初体验","date":"2020-03-07T13:36:20.000Z","updated":"2023-09-30T08:39:39.667Z","comments":true,"path":"api/articles/Elastic-Stack实战之Metricbeat初体验.json","excerpt":null,"keywords":"南国薏米","cover":"https://image.eelve.com/eblog/screenshot-infrastructure-ui-d2c3e13f47f74d82a6f0f6c2799d94f8.png","content":"<p>【<strong>前面的话</strong>】<a href=\"https://eelve.com/posts/d1a5ff40.html\">前面介绍了Elastic Stack的Beats家族</a>，并且<a href=\"https://eelve.com/posts/1d8b943d.html\">体验了Filebeat</a>，接下来我们就继续来体验一下</p>\n<hr>\n<h1 id=\"壹、软件版本\"><a href=\"#壹、软件版本\" class=\"headerlink\" title=\"壹、软件版本\"></a>壹、软件版本</h1><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">Centos：CentOS-7-x86_64-Minimal-1908</span></span><br><span class=\"line\"><span class=\"attr\">VM:</span> <span class=\"number\">15.5</span><span class=\"number\">.0</span> <span class=\"string\">build-14665864</span></span><br><span class=\"line\"><span class=\"attr\">Java:</span> <span class=\"number\">1.8</span><span class=\"string\">.0_211</span></span><br><span class=\"line\"><span class=\"attr\">Elasticsearch:</span> <span class=\"string\">elasticsearch-7.6.0</span></span><br><span class=\"line\"><span class=\"attr\">Logstash:</span> <span class=\"string\">logstash-7.6.0</span></span><br><span class=\"line\"><span class=\"attr\">Kibana:</span> <span class=\"string\">kibana-7.6.0</span></span><br><span class=\"line\"><span class=\"string\">MetricBeat：filebeat-7.6.0</span></span><br></pre></td></tr></table></figure>\n<h1 id=\"贰、MetricBeat介绍\"><a href=\"#贰、MetricBeat介绍\" class=\"headerlink\" title=\"贰、MetricBeat介绍\"></a>贰、MetricBeat介绍</h1><p>MetricBeat是一种轻量型指标采集器，用于从系统和服务收集指标。Metricbeat 能够以一种轻量型的方式，输送各种系统和服务统计数据，从 CPU 到内存，从 Redis 到 Nginx，不一而足。</p>\n<ul>\n<li>系统级监控，更简洁</li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/screenshot-infrastructure-ui-d2c3e13f47f74d82a6f0f6c2799d94f8.png\" alt=\"screenshot-infrastructure-ui\"></p>\n<ul>\n<li><p>单个二进制文件提供多种模块</p>\n<p>Metricbeat 提供多种内部模块，这些模块可从多项服务（诸如 Apache、Jolokia、NGINX、MongoDB、MySQL、PostgreSQL、Prometheus 等等）中收集指标。安装简单，完全零依赖性。只需在配置文件中启用您所需的模块即可。</p>\n<p>而且，如果您没有看到要找的模块，还可以自己构建。以 Go 语言编写 Metricbeat 模块，过程十分简单。 </p>\n<ul>\n<li>系统</li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/metricbeat-modules-system-7f76e2200cfb40089bb112f50aae710e.jpg\" alt=\"metricbeat-modules-system\"></p>\n<ul>\n<li>Docker</li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/container-monitoring-screenshot-carousel-docker-908943a547964d11996a9775855235f0.jpg\" alt=\"container-monitoring-screenshot-carousel-docker\"></p>\n<ul>\n<li>MongoDB</li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/metricbeat-modules-mongo-d5d719649a7a4e2a9bf9f1a984528efc.jpg\" alt=\"metricbeat-modules-mongo\"></p>\n<ul>\n<li>Kubernetes</li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/container-monitoring-screenshot-carousel-kubernetes-0ee5a1fdacf74c3b82d12c81c5c14af1.jpg\" alt=\"container-monitoring-screenshot-carousel-kubernetes\"></p>\n</li>\n<li><p>容器就绪 </p>\n<p>近来是不是所有工作都转移到了 Docker 中？通过 Elastic Stack，您能够轻松地监测容器。将 Metricbeat 部署到同一台主机上的一个单独容器后，它将收集与主机上运行的其他每一个容器相关的统计数据。在收集统计数据时，它直接从 proc 文件系统读取 cgroup 信息，这就意味着它无需特权即可访问 Docker API，并且同样适用于其他 Runtime。针对 Docker 的 Autodiscovery 让事情进一步简化，您只需指定一个条件即可开启 Metricbeat 模块。 </p>\n</li>\n<li><p>不错过任何检测信号</p>\n<p>将指标通过假脱机传输方式输送至磁盘，这样您的数据管道再也不会错过任何一个数据点，即使发生中断（例如网络问题），也勿需担心。Metricbeat 会保留传入的数据，并在重新上线后将这些指标输送至 Elasticsearch 或 Logstash。 </p>\n</li>\n</ul>\n<ul>\n<li><p>输送至 Elasticsearch 或 Logstash。在 Kibana 中实现可视化。</p>\n<p>Metricbeat 是 Elastic Stack 的一部分，因此能够与 Logstash、Elasticsearch 和 Kibana 无缝协作。无论您要使用 Logstash 转换或充实指标，还是在 Elasticsearch 中随意处理一些数据分析，亦或在 Kibana 中构建和分享仪表板，Metricbeat 都能轻松地将您的数据发送至最关键的地方。</p>\n</li>\n</ul>\n<h1 id=\"叁-MetricBeat安装\"><a href=\"#叁-MetricBeat安装\" class=\"headerlink\" title=\"叁 MetricBeat安装\"></a>叁 MetricBeat安装</h1><h2 id=\"3-1-下载地址\"><a href=\"#3-1-下载地址\" class=\"headerlink\" title=\"3.1 下载地址\"></a>3.1 下载地址</h2><p><a href=\"https://artifacts.elastic.co/downloads/beats/filebeat/metricBeat-7.6.0-linux-x86_64.tar.gz\">metricBeat-7.6.0-linux-x86_64</a></p>\n<h2 id=\"3-2-解压metricBeat-7-6-0-linux-x86-64\"><a href=\"#3-2-解压metricBeat-7-6-0-linux-x86-64\" class=\"headerlink\" title=\"3.2 解压metricBeat-7.6.0-linux-x86_64\"></a>3.2 解压metricBeat-7.6.0-linux-x86_64</h2><figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar -zvxf metricBeat-7.6.0-linux-x86_64.tar.gz -C /usr/elastic</span><br></pre></td></tr></table></figure>\n<h2 id=\"3-3-使用Kibana展示Metricbeat系统指标\"><a href=\"#3-3-使用Kibana展示Metricbeat系统指标\" class=\"headerlink\" title=\"3.3 使用Kibana展示Metricbeat系统指标\"></a>3.3 使用Kibana展示Metricbeat系统指标</h2><ul>\n<li>修改Metricbeat配置</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">output.elasticsearch:</span><br><span class=\"line\"><span class=\"meta\">  #</span><span class=\"bash\"> Array of hosts to connect to.</span></span><br><span class=\"line\">  hosts: [&quot;http://192.168.237.11:9200&quot;]</span><br></pre></td></tr></table></figure>\n<ul>\n<li>启动</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[iio@192 metricbeat]$ ./metricbeat -e</span><br></pre></td></tr></table></figure>\n<ul>\n<li>在Elasticsearch中查看采集的数据</li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/2020030707-906f151d4ab34f7c8bbcfea65d83f8e9.png\" alt=\"2020030707\"></p>\n<ul>\n<li>修改Metricbeat配置</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">setup.kibana:</span><br><span class=\"line\">  host: &quot;192.168.237.11:5601&quot;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>安装仪表盘</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./metricbeat setup --dashboards</span><br></pre></td></tr></table></figure>\n<ul>\n<li>重启服务查看效果</li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/2020030708-ba77ee4e36c6478c8b816a314d730f80.png\" alt=\"2020030708\"><br><img src=\"https://image.eelve.com/eblog/2020030709-a40f0d5711fc4707a416e2c39bbbcb79.png\" alt=\"2020030709\"></p>\n<p>到这里我们就监控了我们系统的指标，并且利用Kibana提供的仪表板做了图形化展示。</p>\n<h2 id=\"3-4-使用Kibana展示Metricbeat采集nginx指标\"><a href=\"#3-4-使用Kibana展示Metricbeat采集nginx指标\" class=\"headerlink\" title=\"3.4 使用Kibana展示Metricbeat采集nginx指标\"></a>3.4 使用Kibana展示Metricbeat采集nginx指标</h2><ul>\n<li><p>开启nginx的状态查询</p>\n<p>在nginx中，需要开启状态查询，才能查询到指标数据。</p>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">重新编译nginx</span></span><br><span class=\"line\">./configure --prefix=/usr/local/nginx --with-http_stub_status_module</span><br><span class=\"line\">make</span><br><span class=\"line\">make install</span><br><span class=\"line\"></span><br><span class=\"line\">./nginx -V #查询版本信息</span><br><span class=\"line\">nginx version: nginx/1.12.0</span><br><span class=\"line\">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-39) (GCC) </span><br><span class=\"line\">configure arguments: --prefix=/usr/local/nginx/ --with-http_stub_status_module</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">配置nginx</span></span><br><span class=\"line\">vi nginx.conf</span><br><span class=\"line\">location /nginx-status &#123;</span><br><span class=\"line\">    stub_status on;</span><br><span class=\"line\">    access_log off;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://image.eelve.com/eblog/2020030710-267475b4b77648ccb8d57c0fece62055.png\" alt=\"2020030710\"></p>\n<p>结果说明：</p>\n<ul>\n<li>Active connections：正在处理的活动连接数</li>\n<li>server accepts handled requests<ul>\n<li>第一个 server 表示Nginx启动到现在共处理了22个连接</li>\n<li>第二个 accepts 表示Nginx启动到现在共成功创建 22 次握手</li>\n<li>第三个 handled requests 表示总共处理了 193 次请求</li>\n<li>请求丢失数 = 握手数 - 连接数 ，可以看出目前为止没有丢失请求</li>\n</ul>\n</li>\n<li>Reading: 0 Writing: 1 Waiting: 2<ul>\n<li>Reading：Nginx 读取到客户端的 Header 信息数</li>\n<li>Writing：Nginx 返回给客户端 Header 信息数</li>\n<li>Waiting：Nginx 已经处理完正在等候下一次请求指令的驻留链接（开启keep-alive的情况下，这个值等于 Active - (Reading+Writing)）</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<ul>\n<li><p>配置Nginx Module</p>\n<p>默认Metricbeat之开启了system modules，所以我们这里要手动启用nginx modules</p>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./metricbeat modules enable nginx</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[iio@192 metricbeat]$ ./metricbeat modules list</span><br><span class=\"line\">Enabled:</span><br><span class=\"line\">nginx</span><br><span class=\"line\">system</span><br><span class=\"line\"></span><br><span class=\"line\">Disabled:</span><br><span class=\"line\">activemq</span><br><span class=\"line\">aerospike</span><br><span class=\"line\">apache</span><br><span class=\"line\">appsearch</span><br><span class=\"line\">aws</span><br><span class=\"line\">azure</span><br><span class=\"line\">beat</span><br><span class=\"line\">beat-xpack</span><br><span class=\"line\">ceph</span><br><span class=\"line\">cockroachdb</span><br><span class=\"line\">consul</span><br><span class=\"line\">coredns</span><br><span class=\"line\">couchbase</span><br><span class=\"line\">couchdb</span><br><span class=\"line\">docker</span><br><span class=\"line\">dropwizard</span><br><span class=\"line\">elasticsearch</span><br><span class=\"line\">elasticsearch-xpack</span><br><span class=\"line\">envoyproxy</span><br><span class=\"line\">etcd</span><br><span class=\"line\">golang</span><br><span class=\"line\">googlecloud</span><br><span class=\"line\">graphite</span><br><span class=\"line\">haproxy</span><br><span class=\"line\">http</span><br><span class=\"line\">jolokia</span><br><span class=\"line\">kafka</span><br><span class=\"line\">kibana</span><br><span class=\"line\">kibana-xpack</span><br><span class=\"line\">kubernetes</span><br><span class=\"line\">kvm</span><br><span class=\"line\">logstash</span><br><span class=\"line\">logstash-xpack</span><br><span class=\"line\">memcached</span><br><span class=\"line\">mongodb</span><br><span class=\"line\">mssql</span><br><span class=\"line\">munin</span><br><span class=\"line\">mysql</span><br><span class=\"line\">nats</span><br><span class=\"line\">oracle</span><br><span class=\"line\">php_fpm</span><br><span class=\"line\">postgresql</span><br><span class=\"line\">prometheus</span><br><span class=\"line\">rabbitmq</span><br><span class=\"line\">redis</span><br><span class=\"line\">sql</span><br><span class=\"line\">stan</span><br><span class=\"line\">statsd</span><br><span class=\"line\">tomcat</span><br><span class=\"line\">traefik</span><br><span class=\"line\">uwsgi</span><br><span class=\"line\">vsphere</span><br><span class=\"line\">windows</span><br><span class=\"line\">zookeeper</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>修改nginx modules的配置</p>\n<figure class=\"highlight shell\"><figcaption><span>script</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[iio@192 modules.d]$ vi nginx.yml </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> Module: nginx</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> Docs: https://www.elastic.co/guide/en/beats/metricbeat/7.6/metricbeat-module-nginx.html</span></span><br><span class=\"line\"></span><br><span class=\"line\">- module: nginx</span><br><span class=\"line\"><span class=\"meta\">  #</span><span class=\"bash\">metricsets:</span></span><br><span class=\"line\"><span class=\"meta\">  #</span><span class=\"bash\">  - stubstatus</span></span><br><span class=\"line\">  period: 10s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span><span class=\"bash\"> Nginx hosts</span></span><br><span class=\"line\">  hosts: [&quot;http://192.168.237.11&quot;]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span><span class=\"bash\"> Path to server status. Default server-status</span></span><br><span class=\"line\">  server_status_path: &quot;nginx-status&quot; #配置的nginx状态访问地址</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span><span class=\"bash\">username: <span class=\"string\">&quot;user&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">  #</span><span class=\"bash\">password: <span class=\"string\">&quot;secret&quot;</span></span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n<li><p>启动测试</p>\n</li>\n</ul>\n<p><img src=\"https://image.eelve.com/eblog/2020030711-c1217270b05241ca96fa42f063ba8d9f.png\" alt=\"2020030711\"><br><img src=\"https://image.eelve.com/eblog/2020030712-8ae5730e5301448b974d67545ff98e7a.png\" alt=\"2020030712\"></p>\n<p>到这里我们采集的nginx的指标数据，并且利用Kibana安装的Metricbeatd的nginx仪表盘做了图形化展示。</p>\n<h1 id=\"肆、Metricbeat组成\"><a href=\"#肆、Metricbeat组成\" class=\"headerlink\" title=\"肆、Metricbeat组成\"></a>肆、Metricbeat组成</h1><p>Metricbeat有2部分组成，一部分是Module，另一部分为Metricset。</p>\n<ul>\n<li><p>Module</p>\n<p>收集的对象，如：mysql、redis、nginx、操作系统等；</p>\n</li>\n<li><p>Metricset</p>\n<p>收集指标的集合，如：cpu、memory、network等；  </p>\n</li>\n</ul>\n<hr>\n<p>【<strong>后面的话</strong>】在本文中我们利用Metricbeat监控了系统和nginx的系统指标，并且做了图标化的展示。其他module的使用也类似，他们都是利用Metricbeat给被监控的机器放松状态指令，然后采集数据，再做图形化的展示。同时我们也看到Merticbeat也内置了很多的module，足够了我们日工作需要了。</p>\n<hr>\n<p><img src=\"https://image.eelve.com/eblog/eblog-b269767ff45b4e01a1c380e38898c1c0.png\" alt=\"薏米笔记\"></p>\n","raw":null,"categories":[{"name":"Elastic-Stack","path":"api/categories/Elastic-Stack.json"}],"tags":[{"name":"ELK","path":"api/tags/ELK.json"},{"name":"Beats","path":"api/tags/Beats.json"},{"name":"MetricBeat","path":"api/tags/MetricBeat.json"}]}]}